<?xml version="1.0" encoding="utf-8" ?> 
<shader type="xmlshader" name="or_lighting_detail_add">
    <technique priority="200">
	<pass>
	    <buffer name="vertices" destination="position" />
	    <buffer name="colors" destination="primary color" />
	    <buffer name="texture coordinates" destination="texture coordinate 0" />
	    <buffer name="texture coordinates" destination="texture coordinate 1" />
	    <buffer name="lightmap coordinates" destination="texture coordinate 2" />
	    <texture name="tex detail" destination="unit 0" />
	    <texture name="tex diffuse" destination="unit 1" />
	    <texture name="tex lightmap" destination="unit 2" />
	    <texture name="tex diffuse" destination="unit 3" />
	    <vp plugin="glfixed">
	      <fixedvp>
		<texmatrix destination="unit 0">
		  <scale type="shadervar">detail texture scale</scale>
		</texmatrix>
	      </fixedvp>
	    </vp>
	    <fp plugin="glfixed">
		<fixedfp>
		    <layer>
			<colorsource num="0" source="texture" modifier="color"/>
			<coloroperation operation="replace" />
		    </layer>
		    <layer>
			<colorsource num="0" source="texture" modifier="color"/>
			<colorsource num="1" source="previous layer" modifier="color"/>
			<coloroperation operation="add" />
                        <alphasource num="0" source="texture" modifier="alpha"/>
                        <alphaoperation operation="replace"/>
		    </layer>
		    <layer>
			<colorsource num="0" source="previous layer" modifier="color"/>
			<colorsource num="1" source="texture" modifier="color"/>
			<coloroperation operation="modulate" scale="2" />
                        <alphasource num="0" source="previous layer" modifier="alpha"/>
                        <alphaoperation operation="replace"/>
		    </layer>
		    <layer>
			<colorsource num="0" source="primary color" modifier="color"/>
			<colorsource num="1" source="previous layer" modifier="color"/>
			<coloroperation operation="modulate"/>
                        <alphasource num="0" source="previous layer" modifier="alpha"/>
                        <alphaoperation operation="replace"/>
		    </layer>
		</fixedfp>
	    </fp>
	</pass>
    </technique>
    <technique priority="100">
	<pass>
	    <buffer name="vertices" destination="position" />
	    <buffer name="colors" destination="primary color" />
	    <buffer name="texture coordinates" destination="texture coordinate 0" />
	    <buffer name="lightmap coordinates" destination="texture coordinate 1" />
	    <texture name="tex diffuse" destination="unit 0" />
	    <texture name="tex lightmap" destination="unit 1" />
	    <fp plugin="glfixed">
		<fixedfp>
		    <layer>
			<colorsource num="0" source="texture" modifier="color"/>
			<colorsource num="1" source="primary color" modifier="color"/>
			<coloroperation operation="modulate" />
                        <alphasource num="0" source="texture" modifier="alpha"/>
			<alphasource num="1" source="primary color" modifier="alpha"/>
                        <alphaoperation operation="modulate" />
		    </layer>
		    <layer>
			<colorsource num="0" source="previous layer" modifier="color"/>
			<colorsource num="1" source="texture" modifier="color"/>
			<coloroperation operation="modulate" scale="2" />
                        <alphasource num="0" source="previous layer" modifier="alpha"/>
                        <alphaoperation operation="replace"/>
		    </layer>
		</fixedfp>
	    </fp>
	</pass>
    </technique>
    <technique priority="75">
      <pass>
	<buffer name="vertices" destination="position" />
	<buffer name="normals" destination="normal" />
	<buffer name="texture coordinates" destination="texture coordinate" />
	<buffer name="colors" destination="color" />
	<vp plugin="software" />
	<fp plugin="software" />
      </pass>
    </technique>
    <technique priority="50">
	<pass>
	    <buffer name="vertices" destination="position" />
	    <buffer name="colors" destination="primary color" />
	    <buffer name="texture coordinates" destination="texture coordinate 0" />
	    <texture name="tex diffuse" destination="unit 0" />
	</pass>
	<pass>
	    <mixmode><multiply2 /></mixmode><!-- @@@ probably not always desired -->
	    <zmode><zmesh2 /></zmode>
	    <buffer name="vertices" destination="position" />
	    <buffer name="lightmap coordinates" destination="texture coordinate 0" />
	    <texture name="tex lightmap" destination="unit 0" />
	</pass>
    </technique>
</shader>
