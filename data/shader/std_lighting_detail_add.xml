<?xml version="1.0" encoding="utf-8" ?>
<shader compiler="xmlshader" name="std_lighting_detail_add">
  <technique priority="200">
    <tag>detail texture</tag>
    <pass>
      <buffer source="texture coordinate 0" destination="texture coordinate 1" />
      <buffer source="texture coordinate lightmap" destination="texture coordinate 2" />
      <texture name="tex detail" destination="unit 0" />
      <texture name="tex diffuse" destination="unit 1" />
      <texture name="tex lightmap" destination="unit 2" />
      <texture name="tex diffuse" destination="unit 3" />
      <vp plugin="glfixed">
        <fixedvp>
          <texmatrix layer="0">
            <scale type="shadervar">detail texture scale</scale>
          </texmatrix>
        </fixedvp>
      </vp>
      <fp plugin="glfixed">
        <fixedfp>
          <layer>
            <colorsource num="0" source="texture" modifier="color" />
            <coloroperation operation="replace" />
          </layer>
          <layer>
            <colorsource num="0" source="texture" modifier="color" />
            <colorsource num="1" source="previous layer" modifier="color" />
            <coloroperation operation="add" />
            <alphasource num="0" source="texture" modifier="alpha" />
            <alphaoperation operation="replace" />
          </layer>
          <layer>
            <colorsource num="0" source="previous layer" modifier="color" />
            <colorsource num="1" source="texture" modifier="color" />
            <coloroperation operation="modulate" scale="2" />
            <alphasource num="0" source="previous layer" modifier="alpha" />
            <alphaoperation operation="replace" />
          </layer>
          <layer>
            <colorsource num="0" source="primary color" modifier="color" />
            <colorsource num="1" source="previous layer" modifier="color" />
            <coloroperation operation="modulate" />
            <alphasource num="0" source="previous layer" modifier="alpha" />
            <alphaoperation operation="replace" />
          </layer>
        </fixedfp>
      </fp>
    </pass>
    <?include snippets/fog-pass.inc ?>
  </technique>
  <technique priority="150">
    <tag>detail texture</tag>
    <tag>multipass detail texture</tag>
    <pass>
      <texture name="tex diffuse" destination="unit 0" />
    </pass>
    <pass>
      <mixmode>
        <add />
      </mixmode>
      <zmode>
        <zmesh2 />
      </zmode>
      <texture name="tex detail" destination="unit 0" />
      <vp plugin="glfixed">
        <fixedvp>
          <texmatrix layer="0">
            <scale type="shadervar">detail texture scale</scale>
          </texmatrix>
        </fixedvp>
      </vp>
    </pass>
    <pass>
      <mixmode>
        <multiply2 />
      </mixmode>
      <zmode>
        <zmesh2 />
      </zmode>
      <buffer source="texture coordinate lightmap" destination="texture coordinate 0" />
      <texture name="tex lightmap" destination="unit 0" />
    </pass>
    <?include snippets/fog-pass.inc ?>
  </technique>
  <technique priority="100">
    <pass>
      <buffer source="texture coordinate lightmap" destination="texture coordinate 1" />
      <texture name="tex diffuse" destination="unit 0" />
      <texture name="tex lightmap" destination="unit 1" />
      <fp plugin="glfixed">
        <fixedfp>
          <layer>
            <colorsource num="0" source="texture" modifier="color" />
            <colorsource num="1" source="primary color" modifier="color" />
            <coloroperation operation="modulate" />
            <alphasource num="0" source="texture" modifier="alpha" />
            <alphasource num="1" source="primary color" modifier="alpha" />
            <alphaoperation operation="modulate" />
          </layer>
          <layer>
            <colorsource num="0" source="previous layer" modifier="color" />
            <colorsource num="1" source="texture" modifier="color" />
            <coloroperation operation="modulate" scale="2" />
            <alphasource num="0" source="previous layer" modifier="alpha" />
            <alphaoperation operation="replace" />
          </layer>
        </fixedfp>
      </fp>
    </pass>
    <?include snippets/fog-pass.inc ?>
  </technique>
  <technique priority="75">
    <pass>
      <buffer source="normal" destination="normal" />
      <vp plugin="software" />
      <fp plugin="software" />
    </pass>
  </technique>
  <technique priority="50">
    <pass>
      <texture name="tex diffuse" destination="unit 0" />
    </pass>
    <pass>
      <mixmode>
        <multiply2 />
      </mixmode> <!-- @@@ probably not always desired -->
      <zmode>
        <zmesh2 />
      </zmode>
      <buffer source="texture coordinate lightmap" destination="texture coordinate 0" />
      <texture name="tex lightmap" destination="unit 0" />
    </pass>
    <?include snippets/fog-pass.inc ?>
  </technique>
</shader>
