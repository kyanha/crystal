<shader type="xmlshader" name="stat_dyn_reflect">
    <technique priority="100">
	<pass>
	    <buffer name="vertices" destination="position" />
	    <buffer name="colors" destination="primary color" />
    	    <buffer name="texture coordinates" destination="texture coordinate 0" />
          <buffer name="normals" destination="normal"/>
      	 <texture name="tex reflection" destination="unit 0" />
      	  <vp plugin="glfixed">
        	   <fixedvp>  
          	    <texgen type="reflection" mapping="cube" />
          	    <!--<ambient/>-->
        	   </fixedvp>
      	 </vp>
	     <!-- textured material -->
	     <buffer name="texture coordinates" destination="texture coordinate 0" />
	     <texture name="tex reflection" destination="unit 0" />

	    <?if vars."tex lightmap".texture ?>
		<buffer name="lightmap coordinates" destination="texture coordinate 3" />
		<texture name="tex lightmap" destination="unit 3" />

	    <?if vars."tex mask".texture ?>
		<buffer name="texture coordinates" destination="texture coordinate 2" scale="10" />
		<texture name="tex mask" destination="unit 2" scale="10" />

	     <?if vars."tex diffuse".texture ?>
		<buffer name="normals" destination="texture coordinate 1" />
		<texture name="tex diffuse" destination="unit 3" />

	     <?endif?>
	    <?else?>

	     <?if vars."tex reflection".texture ?>
		<buffer name="texture coordinates" destination="texture coordinate 3" />
		<texture name="tex reflection" destination="unit 1" />

	     <?endif?>
	    <?endif?>

	    <fp plugin="glfixed">
		<fixedfp>
		    <layer>
			<colorsource num="1" source="texture" modifier="color"/>
			<colorsource num="0" source="primary color" modifier="color"/>
			<coloroperation operation="modulate" />
			<alphasource num="1" source="texture" modifier="alpha"/>
			<alphasource num="0" source="primary color" modifier="alpha"/>
			<alphaoperation operation="modulate" />
		    </layer>

		    <?if vars."tex lightmap".texture ?>
		      <layer>
			  <colorsource num="0" source="primary color" modifier="color"/>
			  <colorsource num="0" source="primary color" modifier="color"/>
			  <coloroperation operation="modulate" scale="2" />

		      </layer>

		    <?endif?>

		    <?if vars."tex mask".texture ?>
		      <layer>
			  <colorsource num="0" source="previous layer" modifier="color"/>
			  <colorsource num="1" source="texture" modifier="color"/>
			  <coloroperation operation="add" scale="1" />
			  <alphasource num="0" source="previous layer" modifier="alpha"/>
			  <alphaoperation operation="replace"/>
		      </layer>

		    <?endif>
		</fixedfp>
	    </fp>
	</pass>
    </technique>
</shader>

