<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>csutil/ref.h Source File (Crystal Space Public API Reference)</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<table border="0" cellpadding="0" cellspacing="0" width="100%" class="head">
 <tr heigth="59">
  <td class="head" width="202" valign="bottom" style="padding-left:0;"><a href="http://www.crystalspace3d.org/"><img src="csblur.png" width="236" height="59" alt="CrystalSpace" border="0"></a></td>
  <td class="head"><h2>Public API Reference</h2></td>
 </tr>
 <tr heigth="11">
  <td colspan="2" class="headshadow" valign="top" style="padding-left:0;"><img src="csblurb.png" width="236" height="11" alt="" border="0"></td>
 </tr>
</table>
<div class="content">
<!-- Generated by Doxygen 1.3.3 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>csutil/ref.h</h1><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">  Crystal Space Smart Pointers</span>
00003 <span class="comment">  Copyright (C) 2002 by Jorrit Tyberghein and Matthias Braun</span>
00004 <span class="comment"></span>
00005 <span class="comment">  This library is free software; you can redistribute it and/or</span>
00006 <span class="comment">  modify it under the terms of the GNU Library General Public</span>
00007 <span class="comment">  License as published by the Free Software Foundation; either</span>
00008 <span class="comment">  version 2 of the License, or (at your option) any later version.</span>
00009 <span class="comment"></span>
00010 <span class="comment">  This library is distributed in the hope that it will be useful,</span>
00011 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00012 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00013 <span class="comment">  Library General Public License for more details.</span>
00014 <span class="comment"></span>
00015 <span class="comment">  You should have received a copy of the GNU Library General Public</span>
00016 <span class="comment">  License along with this library; if not, write to the Free</span>
00017 <span class="comment">  Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
00018 <span class="comment">*/</span>
00019 
00020 <span class="preprocessor">#ifndef __CS_REF_H__</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#define __CS_REF_H__</span>
00022 <span class="preprocessor"></span>
00023 <span class="preprocessor">#include "csextern.h"</span>
00024 
00025 <span class="preprocessor">#define CS_VOIDED_PTR 0xffffffff</span>
00026 <span class="preprocessor"></span>
00027 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keyword">class </span><a class="code" href="classcsRef.html">csRef</a>;
00028 
00029 <span class="preprocessor">#if defined(CS_DEBUG)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#  define CS_TEST_VOIDPTRUSAGE</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#  undef CS_TEST_VOIDPTRUSAGE</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span>
00035 <span class="preprocessor">#ifdef CS_REF_TRACKER</span>
00036 <span class="preprocessor"></span><span class="preprocessor"> #include &lt;typeinfo&gt;</span>
00037 <span class="preprocessor"> #include "csutil/reftrackeraccess.h"</span>
00038 
00039 <span class="preprocessor"> #define CSREF_TRACK(x, cmd, refCount, obj, tag)    \</span>
00040 <span class="preprocessor">  {                                                 \</span>
00041 <span class="preprocessor">    const int rc = obj ? refCount : -1;             \</span>
00042 <span class="preprocessor">    if (obj) cmd;                                   \</span>
00043 <span class="preprocessor">    if (obj)                                        \</span>
00044 <span class="preprocessor">    {                                               \</span>
00045 <span class="preprocessor">      csRefTrackerAccess::SetDescription (obj,      \</span>
00046 <span class="preprocessor">        typeid(T).name());                          \</span>
00047 <span class="preprocessor">      csRefTrackerAccess::Match ## x (obj, rc, tag);\</span>
00048 <span class="preprocessor">    }                                               \</span>
00049 <span class="preprocessor">  }</span>
00050 <span class="preprocessor"></span><span class="preprocessor"> #define CSREF_TRACK_INCREF(obj,tag)    \</span>
00051 <span class="preprocessor">  CSREF_TRACK(IncRef, obj-&gt;IncRef(), obj-&gt;GetRefCount(), obj, tag);</span>
00052 <span class="preprocessor"></span><span class="preprocessor"> #define CSREF_TRACK_DECREF(obj,tag)    \</span>
00053 <span class="preprocessor">  CSREF_TRACK(DecRef, obj-&gt;DecRef(), obj-&gt;GetRefCount(), obj, tag);</span>
00054 <span class="preprocessor"></span><span class="preprocessor"> #define CSREF_TRACK_ASSIGN(obj,tag)    \</span>
00055 <span class="preprocessor">  CSREF_TRACK(IncRef, (0), obj-&gt;GetRefCount() - 1, obj, tag);</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00057 <span class="preprocessor"></span><span class="preprocessor"> #define CSREF_TRACK_INCREF(obj,tag) \</span>
00058 <span class="preprocessor">  if (obj) obj-&gt;IncRef();</span>
00059 <span class="preprocessor"></span><span class="preprocessor"> #define CSREF_TRACK_DECREF(obj,tag) \</span>
00060 <span class="preprocessor">  if (obj) obj-&gt;DecRef();</span>
00061 <span class="preprocessor"></span><span class="preprocessor"> #define CSREF_TRACK_ASSIGN(obj,tag)</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00063 <span class="preprocessor"></span>
00074 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00075"></a><a class="code" href="classcsPtr.html">00075</a> <span class="keyword">class  </span><a class="code" href="classcsPtr.html">csPtr</a>
00076 {
00077 <span class="keyword">private</span>:
00078   <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classcsRef.html">csRef</a>&lt;T&gt;;
00079   T* obj;
00080 
00081 <span class="keyword">public</span>:
00082   <a class="code" href="classcsPtr.html">csPtr</a> (T* p) : obj (p) { CSREF_TRACK_ASSIGN(obj, <span class="keyword">this</span>); }
00083 
00084   <span class="keyword">template</span> &lt;<span class="keyword">class</span> T2&gt;
00085   <span class="keyword">explicit</span> <a class="code" href="classcsPtr.html">csPtr</a> (<a class="code" href="classcsRef.html">csRef&lt;T2&gt;</a> <span class="keyword">const</span>&amp; r) : obj((T2*)r) 
00086   { 
00087     CSREF_TRACK_INCREF (obj, <span class="keyword">this</span>);
00088   }
00089 
00090 <span class="preprocessor">#ifdef CS_TEST_VOIDPTRUSAGE</span>
00091 <span class="preprocessor"></span>  ~<a class="code" href="classcsPtr.html">csPtr</a> ()
00092   {
00093     <span class="comment">// If not assigned to a csRef we have a problem (leak).</span>
00094     <span class="comment">// So if this assert fires for you, then you are calling</span>
00095     <span class="comment">// a function that returns a csPtr and not using the result</span>
00096     <span class="comment">// (or at least not assigning it to a csRef). This is a memory</span>
00097     <span class="comment">// leak and you should fix that.</span>
00098     CS_ASSERT_MSG (<span class="stringliteral">"csPtr&lt;&gt; was not assigned to a csRef&lt;&gt; prior destruction"</span>, 
00099       obj == (T*)CS_VOIDED_PTR);
00100   }
00101 <span class="preprocessor">#endif</span>
00102 <span class="preprocessor"></span>
00103   <a class="code" href="classcsPtr.html">csPtr</a> (<span class="keyword">const</span> <a class="code" href="classcsPtr.html">csPtr&lt;T&gt;</a>&amp; copy)
00104   {
00105     obj = copy.<a class="code" href="classcsPtr.html#r0">obj</a>;
00106 <span class="preprocessor">#ifdef CS_TEST_VOIDPTRUSAGE</span>
00107 <span class="preprocessor"></span>    ((<a class="code" href="classcsPtr.html">csPtr&lt;T&gt;</a>&amp;)copy).obj = (T*)CS_VOIDED_PTR;
00108 <span class="preprocessor">#endif</span>
00109 <span class="preprocessor"></span>  }
00110 };
00111 
00118 <span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt;
<a name="l00119"></a><a class="code" href="classcsRef.html">00119</a> <span class="keyword">class  </span><a class="code" href="classcsRef.html">csRef</a>
00120 {
00121 <span class="keyword">private</span>:
00122   T* obj;
00123 
00124 <span class="keyword">public</span>:
<a name="l00130"></a><a class="code" href="classcsRef.html#a0">00130</a>   <a class="code" href="classcsRef.html#a0">csRef</a> () : obj (0) {}
00131 
<a name="l00137"></a><a class="code" href="classcsRef.html#a1">00137</a>   <a class="code" href="classcsRef.html#a0">csRef</a> (<span class="keyword">const</span> <a class="code" href="classcsPtr.html">csPtr&lt;T&gt;</a>&amp; newobj)
00138   {
00139     obj = newobj.<a class="code" href="classcsPtr.html#r0">obj</a>;
00140 <span class="preprocessor">#   ifdef CS_TEST_VOIDPTRUSAGE</span>
00141 <span class="preprocessor"></span>    CS_ASSERT_MSG (<span class="stringliteral">"csPtr&lt;&gt; was already assigned to a csRef&lt;&gt;"</span>,
00142       newobj.<a class="code" href="classcsPtr.html#r0">obj</a> != (T*)CS_VOIDED_PTR);
00143 <span class="preprocessor">#   endif</span>
00144 <span class="preprocessor"></span>    <span class="comment">// The following line is outside the ifdef to make sure</span>
00145     <span class="comment">// we have binary compatibility.</span>
00146     ((<a class="code" href="classcsPtr.html">csPtr&lt;T&gt;</a>&amp;)newobj).obj = (T*)CS_VOIDED_PTR;
00147   }
00148 
<a name="l00153"></a><a class="code" href="classcsRef.html#a2">00153</a>   <a class="code" href="classcsRef.html#a0">csRef</a> (T* newobj) : obj (newobj)
00154   {
00155     CSREF_TRACK_INCREF (obj, <span class="keyword">this</span>);
00156   }
00157   
00161   <span class="keyword">template</span> &lt;<span class="keyword">class</span> T2&gt;
<a name="l00162"></a><a class="code" href="classcsRef.html#a3">00162</a>   <a class="code" href="classcsRef.html#a0">csRef</a> (<a class="code" href="classcsRef.html">csRef&lt;T2&gt;</a> <span class="keyword">const</span>&amp; other) : obj ((T2*)other)
00163   {
00164     CSREF_TRACK_INCREF (obj, <span class="keyword">this</span>);
00165   }
00166 
<a name="l00170"></a><a class="code" href="classcsRef.html#a4">00170</a>   <a class="code" href="classcsRef.html#a0">csRef</a> (<a class="code" href="classcsRef.html">csRef</a> <span class="keyword">const</span>&amp; other) : obj (other.obj)
00171   {
00172     CSREF_TRACK_INCREF (obj, <span class="keyword">this</span>);
00173   }
00174 
<a name="l00178"></a><a class="code" href="classcsRef.html#a5">00178</a>   <a class="code" href="classcsRef.html#a5">~csRef</a> ()
00179   {
00180     CSREF_TRACK_DECREF (obj, <span class="keyword">this</span>);
00181   }
00182 
<a name="l00192"></a><a class="code" href="classcsRef.html#a6">00192</a>   <a class="code" href="classcsRef.html">csRef</a>&amp; <a class="code" href="classcsRef.html#a6">operator = </a>(<span class="keyword">const</span> <a class="code" href="classcsPtr.html">csPtr&lt;T&gt;</a>&amp; newobj)
00193   {
00194     T* oldobj = obj;
00195     <span class="comment">// First assign and then DecRef() of old object!</span>
00196     obj = newobj.<a class="code" href="classcsPtr.html#r0">obj</a>;
00197 <span class="preprocessor">#   ifdef CS_TEST_VOIDPTRUSAGE</span>
00198 <span class="preprocessor"></span>    CS_ASSERT_MSG (<span class="stringliteral">"csPtr&lt;&gt; was already assigned to a csRef&lt;&gt;"</span>,
00199       newobj.<a class="code" href="classcsPtr.html#r0">obj</a> != (T*)CS_VOIDED_PTR);
00200 <span class="preprocessor">#   endif</span>
00201 <span class="preprocessor"></span>    <span class="comment">// The following line is outside the ifdef to make sure</span>
00202     <span class="comment">// we have binary compatibility.</span>
00203     ((<a class="code" href="classcsPtr.html">csPtr&lt;T&gt;</a>&amp;)newobj).obj = (T*)CS_VOIDED_PTR;
00204     CSREF_TRACK_DECREF (oldobj, <span class="keyword">this</span>);
00205     <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00206   }
00207 
<a name="l00220"></a><a class="code" href="classcsRef.html#a7">00220</a>   <a class="code" href="classcsRef.html">csRef</a>&amp; <a class="code" href="classcsRef.html#a6">operator = </a>(T* newobj)
00221   {
00222     <span class="keywordflow">if</span> (obj != newobj)
00223     {
00224       T* oldobj = obj;
00225       <span class="comment">// It is very important to first assign the new value to</span>
00226       <span class="comment">// 'obj' BEFORE calling DecRef() on the old object. Otherwise</span>
00227       <span class="comment">// it is easy to get in infinite loops with objects being</span>
00228       <span class="comment">// destructed forever (when ref=0 is used for example).</span>
00229       obj = newobj;
00230       CSREF_TRACK_INCREF (newobj, <span class="keyword">this</span>);
00231       CSREF_TRACK_DECREF (oldobj, <span class="keyword">this</span>);
00232     }
00233     <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00234   }
00235 
<a name="l00258"></a><a class="code" href="classcsRef.html#a8">00258</a>   <span class="keywordtype">void</span> <a class="code" href="classcsRef.html#a8">AttachNew</a> (<a class="code" href="classcsPtr.html">csPtr&lt;T&gt;</a> newObj)
00259   {
00260     <span class="comment">// Note: The parameter usage of csPtr&lt;T&gt; instead of csPtr&lt;T&gt;&amp; is</span>
00261     <span class="comment">// deliberate and not to be considered a bug.</span>
00262 
00263     <span class="comment">// Just Re-use csPtr assignment logic</span>
00264     *<span class="keyword">this</span> = newObj;
00265   }
00266 
00268   <span class="keyword">template</span> &lt;<span class="keyword">class</span> T2&gt;
<a name="l00269"></a><a class="code" href="classcsRef.html#a9">00269</a>   <a class="code" href="classcsRef.html">csRef</a>&amp; <a class="code" href="classcsRef.html#a6">operator = </a>(<a class="code" href="classcsRef.html">csRef&lt;T2&gt;</a> <span class="keyword">const</span>&amp; other)
00270   {
00271     T* p = (T2*)other;
00272     this-&gt;<a class="code" href="classcsRef.html#a6">operator=</a>(p);
00273     <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00274   }
00275 
<a name="l00277"></a><a class="code" href="classcsRef.html#a10">00277</a>   <a class="code" href="classcsRef.html">csRef</a>&amp; <a class="code" href="classcsRef.html#a6">operator = </a>(<a class="code" href="classcsRef.html">csRef</a> <span class="keyword">const</span>&amp; other)
00278   {
00279     this-&gt;<a class="code" href="classcsRef.html#a6">operator=</a>(other.<a class="code" href="classcsRef.html#r0">obj</a>);
00280     <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00281   }
00282 
<a name="l00284"></a><a class="code" href="classcsRef.html#n0">00284</a>   <span class="keyword">inline</span> <span class="keyword">friend</span> <span class="keywordtype">bool</span> <a class="code" href="classcsRef.html#n0">operator == </a>(<span class="keyword">const</span> <a class="code" href="classcsRef.html">csRef</a>&amp; r1, <span class="keyword">const</span> <a class="code" href="classcsRef.html">csRef</a>&amp; r2)
00285   {
00286     <span class="keywordflow">return</span> r1.<a class="code" href="classcsRef.html#r0">obj</a> == r2.<a class="code" href="classcsRef.html#r0">obj</a>;
00287   }
<a name="l00289"></a><a class="code" href="classcsRef.html#n1">00289</a>   <span class="keyword">inline</span> <span class="keyword">friend</span> <span class="keywordtype">bool</span> <a class="code" href="classcsRef.html#n1">operator != </a>(<span class="keyword">const</span> <a class="code" href="classcsRef.html">csRef</a>&amp; r1, <span class="keyword">const</span> <a class="code" href="classcsRef.html">csRef</a>&amp; r2)
00290   {
00291     <span class="keywordflow">return</span> r1.<a class="code" href="classcsRef.html#r0">obj</a> != r2.<a class="code" href="classcsRef.html#r0">obj</a>;
00292   }
<a name="l00294"></a><a class="code" href="classcsRef.html#n2">00294</a>   <span class="keyword">inline</span> <span class="keyword">friend</span> <span class="keywordtype">bool</span> <a class="code" href="classcsRef.html#n0">operator == </a>(<span class="keyword">const</span> <a class="code" href="classcsRef.html">csRef</a>&amp; r1, T* obj)
00295   {
00296     <span class="keywordflow">return</span> r1.<a class="code" href="classcsRef.html#r0">obj</a> == obj;
00297   }
<a name="l00299"></a><a class="code" href="classcsRef.html#n3">00299</a>   <span class="keyword">inline</span> <span class="keyword">friend</span> <span class="keywordtype">bool</span> <a class="code" href="classcsRef.html#n1">operator != </a>(<span class="keyword">const</span> <a class="code" href="classcsRef.html">csRef</a>&amp; r1, T* obj)
00300   {
00301     <span class="keywordflow">return</span> r1.<a class="code" href="classcsRef.html#r0">obj</a> != obj;
00302   }
<a name="l00304"></a><a class="code" href="classcsRef.html#n4">00304</a>   <span class="keyword">inline</span> <span class="keyword">friend</span> <span class="keywordtype">bool</span> <a class="code" href="classcsRef.html#n0">operator == </a>(T* obj, <span class="keyword">const</span> <a class="code" href="classcsRef.html">csRef</a>&amp; r1)
00305   {
00306     <span class="keywordflow">return</span> r1.<a class="code" href="classcsRef.html#r0">obj</a> == obj;
00307   }
<a name="l00309"></a><a class="code" href="classcsRef.html#n5">00309</a>   <span class="keyword">inline</span> <span class="keyword">friend</span> <span class="keywordtype">bool</span> <a class="code" href="classcsRef.html#n1">operator != </a>(T* obj, <span class="keyword">const</span> <a class="code" href="classcsRef.html">csRef</a>&amp; r1)
00310   {
00311     <span class="keywordflow">return</span> r1.<a class="code" href="classcsRef.html#r0">obj</a> != obj;
00312   }
00313 
<a name="l00315"></a><a class="code" href="classcsRef.html#a11">00315</a>   T* <a class="code" href="classcsRef.html#a11">operator -&gt; </a>()<span class="keyword"> const</span>
00316 <span class="keyword">  </span>{ <span class="keywordflow">return</span> obj; }
00317   
<a name="l00319"></a><a class="code" href="classcsRef.html#a12">00319</a>   <a class="code" href="classcsRef.html#a12">operator T* </a>()<span class="keyword"> const</span>
00320 <span class="keyword">  </span>{ <span class="keywordflow">return</span> obj; }
00321   
<a name="l00323"></a><a class="code" href="classcsRef.html#a13">00323</a>   T&amp; <a class="code" href="classcsRef.html#a13">operator* </a>()<span class="keyword"> const</span>
00324 <span class="keyword">  </span>{ <span class="keywordflow">return</span> *obj; }
00325 
<a name="l00330"></a><a class="code" href="classcsRef.html#a14">00330</a>   <span class="keywordtype">bool</span> <a class="code" href="classcsRef.html#a14">IsValid</a> ()<span class="keyword"> const</span>
00331 <span class="keyword">  </span>{ <span class="keywordflow">return</span> (obj != 0); }
00332 };
00333 
00334 <span class="preprocessor">#undef CSREF_TRACK_INCREF</span>
00335 <span class="preprocessor"></span><span class="preprocessor">#undef CSREF_TRACK_DECREF</span>
00336 <span class="preprocessor"></span><span class="preprocessor">#undef CSREF_TRACK_ASSIGN</span>
00337 <span class="preprocessor"></span>
00338 <span class="preprocessor">#endif // __CS_REF_H__</span>
</pre></div><hr><address><small>Generated for Crystal Space by 
<a href="http://www.doxygen.org/index.html">doxygen</a> 1.3.3 
</small></address> </div></body> </html>
