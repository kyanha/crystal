<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Crystal Space: csplugincommon/canvas/draw_text.h Source File (Crystal Space Public API Reference)</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<table border="0" cellpadding="0" cellspacing="0" width="100%" class="head">
 <tr heigth="59">
  <td class="head" width="202" valign="bottom" style="padding-left:0;"><a href="http://www.crystalspace3d.org/"><img src="csblur.png" width="236" height="59" alt="CrystalSpace" border="0"></a></td>
  <td class="head"><h2>Public API Reference</h2></td>
 </tr>
 <tr heigth="11">
  <td colspan="2" class="headshadow" valign="top" style="padding-left:0;"><img src="csblurb.png" width="236" height="11" alt="" border="0"></td>
 </tr>
</table>
<div class="content">
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000005.html">csplugincommon</a>&nbsp;/&nbsp;<a class="el" href="dir_000006.html">canvas</a></div>
<h1>draw_text.h</h1><a href="draw__text_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">    Copyright (C) 2004 by Jorrit Tyberghein</span>
00003 <span class="comment">              (C) 2004 by Frank Richter</span>
00004 <span class="comment"></span>
00005 <span class="comment">    This library is free software; you can redistribute it and/or</span>
00006 <span class="comment">    modify it under the terms of the GNU Library General Public</span>
00007 <span class="comment">    License as published by the Free Software Foundation; either</span>
00008 <span class="comment">    version 2 of the License, or (at your option) any later version.</span>
00009 <span class="comment"></span>
00010 <span class="comment">    This library is distributed in the hope that it will be useful,</span>
00011 <span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00012 <span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00013 <span class="comment">    Library General Public License for more details.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    You should have received a copy of the GNU Library General Public</span>
00016 <span class="comment">    License along with this library; if not, write to the Free</span>
00017 <span class="comment">    Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
00018 <span class="comment">*/</span>
00019 
00020 <span class="preprocessor">#ifndef __CS_CSPLUGINCOMMON_CANVAS_DRAW_TEXT_H__</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#define __CS_CSPLUGINCOMMON_CANVAS_DRAW_TEXT_H__</span>
00022 <span class="preprocessor"></span>
00027 <span class="preprocessor">#include "<a class="code" href="csuctransform_8h.html">csutil/csuctransform.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="draw__common_8h.html">draw_common.h</a>"</span>
00029 <span class="preprocessor">#include "csplugincommon/canvas/softfontcache.h"</span>
00030 
00037 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Tpixel, <span class="keyword">class</span> Tpixmixer1, <span class="keyword">class</span> Tpixmixer2, <span class="keyword">class</span> Tpixmixer3&gt;
<a name="l00038"></a><a class="code" href="classcsG2DDrawText.html">00038</a> <span class="keyword">class </span><a class="code" href="classcsG2DDrawText.html">csG2DDrawText</a>
00039 {
00040 <span class="keyword">public</span>:
00041   <span class="keyword">static</span> <span class="keywordtype">void</span> DrawText (csSoftFontCache* cache, <a class="code" href="structiFont.html">iFont</a>* font, <span class="keywordtype">int</span> pen_x, <span class="keywordtype">int</span> pen_y,
00042     Tpixel fg, uint8 alphaFG, Tpixel bg, uint8 alphaBG, <span class="keyword">const</span> <a class="code" href="group__util.html#ga15">utf8_char</a> *text, 
00043     <a class="code" href="group__util.html#ga12">uint</a> flags)
00044   {
00045     <a class="code" href="classcsGraphics2D.html">csGraphics2D</a>* G2D = cache-&gt;G2D;
00046     <span class="keyword">const</span> <span class="keywordtype">int</span> ClipX1 = cache-&gt;ClipX1, ClipY1 = cache-&gt;ClipY1, 
00047       ClipX2 = cache-&gt;ClipX2, ClipY2 = cache-&gt;ClipY2;
00048     Tpixmixer1 mixerFG (G2D, fg, alphaFG);
00049     Tpixmixer2 mixerBG (G2D, bg, alphaBG);
00050     
00051     <span class="keywordflow">if</span> (!font)
00052       <span class="keywordflow">return</span>;
00053     
00054     <span class="keywordflow">if</span> (!(flags &amp; CS_WRITE_BASELINE)) pen_y += font-&gt;<a class="code" href="structiFont.html#a11">GetAscent</a> ();
00055   
00056     csSoftFontCache::KnownFont* knownFont = cache-&gt;GetCachedFont (font);
00057     <span class="keywordflow">if</span> (knownFont == 0) knownFont = cache-&gt;CacheFont (font);
00058   
00059     size_t textLen = strlen ((<span class="keywordtype">char</span>*)text);
00060     <span class="keywordtype">int</span> charW, charH, advance = 0;
00061     <span class="keywordtype">bool</span> firstchar = <span class="keyword">true</span>;
00062     <span class="keywordflow">while</span> (textLen &gt; 0)
00063     {
00064       <a class="code" href="group__util.html#ga17">utf32_char</a> glyph;
00065       <span class="keywordtype">int</span> skip = <a class="code" href="classcsUnicodeTransform.html#z109_0">csUnicodeTransform::UTF8Decode</a> (text, textLen, glyph, 0);
00066       <span class="keywordflow">if</span> (skip == 0) <span class="keywordflow">break</span>;
00067   
00068       text += skip;
00069       textLen -= skip;
00070   
00071       csSoftFontCache::SoftGlyphCacheData* cacheData = 
00072         (csSoftFontCache::SoftGlyphCacheData*)cache-&gt;CacheGlyph (knownFont, 
00073         glyph, flags);
00074       <span class="keywordflow">if</span> (!cacheData-&gt;hasGlyph) 
00075       {
00076         <span class="comment">// fall back to the default glyph (CS_FONT_DEFAULT_GLYPH)</span>
00077         cacheData = (csSoftFontCache::SoftGlyphCacheData*)cache-&gt;CacheGlyph (
00078           knownFont, <a class="code" href="group__gfx2d.html#ga15">CS_FONT_DEFAULT_GLYPH</a>, flags);
00079         <span class="keywordflow">if</span> (!cacheData-&gt;hasGlyph) <span class="keywordflow">continue</span>;
00080       }
00081   
00082       <span class="keyword">register</span> uint8 *CharImageAlpha = cacheData-&gt;glyphAlphaData;
00083       <span class="keyword">register</span> uint8 *CharImage = cacheData-&gt;glyphData;
00084       <span class="keywordflow">if</span> ((!CharImage) &amp;&amp; (!CharImageAlpha))
00085         <span class="keywordflow">continue</span>;
00086   
00087       <a class="code" href="structcsBitmapMetrics.html">csBitmapMetrics</a>* bmetrics;
00088       <span class="keywordflow">if</span> (CharImageAlpha)
00089       {
00090         bmetrics = &amp;cacheData-&gt;alphaMetrics;
00091       }
00092       <span class="keywordflow">else</span>
00093       {
00094         bmetrics = &amp;cacheData-&gt;bitmapMetrics;
00095       }
00096       charW = bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o0">width</a>;
00097       charH = bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o1">height</a>;
00098       
00099       <span class="keywordtype">int</span> y = pen_y - bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o3">top</a>;
00100       
00101       <span class="comment">// If we are advancing more than the last char was wide, we have to</span>
00102       <span class="comment">// fill the 'gap' with bg.</span>
00103       
00104       <span class="keywordtype">int</span> x = pen_x - (advance &gt; 0 ? advance : 0) + (bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o2">left</a> &lt; 0 ? bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o2">left</a> : 0);
00105       advance += bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o2">left</a>;
00106       
00107       <span class="comment">// Hack: in case the first char has a negative left bitmap offset,</span>
00108       <span class="comment">// some of the background isn't drawn. Fix that.</span>
00109       <span class="keywordflow">if</span> (firstchar)
00110       {
00111         <span class="keywordflow">if</span> (advance &lt; 0)
00112         {
00113           advance = 0;
00114         }
00115         firstchar = <span class="keyword">false</span>;
00116       }
00117      
00118       <span class="keywordflow">if</span> (alphaBG != 0)
00119       {
00120         <span class="keywordflow">while</span> (advance &gt; 0)
00121         {
00122           <span class="keywordflow">if</span> (x &gt;= ClipX2)
00123             <span class="keywordflow">return</span>;
00124     
00125           <span class="keywordtype">int</span> cury = y;
00126           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; charH; i++, cury++)
00127           {
00128             <span class="keywordflow">if</span> ((cury &lt; ClipY1) || (cury &gt;= ClipY2)) <span class="keywordflow">continue</span>;
00129             <span class="keyword">register</span> Tpixel *VRAM = (Tpixel*)G2D-&gt;<a class="code" href="classcsGraphics2D.html#a28">GetPixelAt</a> (x, cury);
00130             <span class="keywordflow">if</span> (x &gt;= ClipX1) mixerBG.Mix (*VRAM);
00131           }
00132           x++; advance--;
00133         }
00134       }
00135       <span class="keywordflow">else</span>
00136       {
00137         <span class="keywordflow">if</span> (advance &gt; 0)
00138         {
00139           x += advance;
00140           advance = 0;
00141         }
00142       }
00143   
00144       <span class="keywordflow">if</span> (x &gt;= ClipX2)
00145         <span class="keywordflow">return</span>;
00146   
00147       <span class="comment">// If character is completely outside the clipping rectangle, continue</span>
00148       <span class="keywordflow">if</span> (!((x + charW &lt;= ClipX1) || (x &gt;= ClipX2)
00149        || (y + charH &lt;= ClipY1) || (y &gt;= ClipY2)))
00150       {
00151         <span class="keywordtype">int</span> cury = y;
00152     
00153         <span class="keywordtype">int</span> oldAdvance = advance;
00154         <span class="comment">// If character should not be clipped, go the fast path</span>
00155         <span class="keywordflow">if</span> ((x &lt; ClipX1) || (x + charW &gt;= ClipX2)
00156          || (y &lt; ClipY1) || (y + charH &gt;= ClipY2))
00157         {
00158           <span class="comment">// Perform full clipping</span>
00159           <span class="keywordtype">int</span> lX = x &lt; ClipX1 ? ClipX1 - x : 0;
00160           <span class="keywordtype">int</span> rX = x + charW &gt;= ClipX2 ? ClipX2 - x : charW;
00161           <span class="keywordtype">int</span> lBytes = CharImageAlpha ? lX : lX &gt;&gt; 3;
00162           <span class="keywordtype">int</span> shiftX = CharImageAlpha ? 0 : lX &amp; 7;
00163           <span class="keywordtype">int</span> bbl = CharImageAlpha ? charW : (charW + 7) / 8; <span class="comment">// bytes per line</span>
00164           <span class="keywordtype">int</span> lAbsX = x + lX;
00165           uint8 *p = CharImageAlpha ? CharImageAlpha - bbl : CharImage - bbl;
00166           
00167           <span class="keywordflow">if</span> (CharImageAlpha)
00168           {
00169             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; charH; i++, cury++)
00170             {
00171               advance = oldAdvance;
00172               p += bbl;
00173               <span class="keywordflow">if</span> ((cury &lt; ClipY1) || (cury &gt;= ClipY2)) 
00174               {
00175                 <span class="keywordflow">if</span> (advance &lt; 0) advance = MIN(0, advance + (rX - lX));
00176                 <span class="keywordflow">continue</span>;
00177               }
00178               CharImageAlpha = p + lBytes;
00179               <span class="keyword">register</span> uint8 CharLine = (*CharImageAlpha++) &lt;&lt; shiftX;
00180               <span class="keyword">register</span> Tpixel* VRAM = (Tpixel*)G2D-&gt;<a class="code" href="classcsGraphics2D.html#a28">GetPixelAt</a> (lAbsX, cury);
00181               <span class="comment">// If we are advancing less than the last char was wide, the current</span>
00182               <span class="comment">// and last chars overlap. So we can't draw opaque, but have to draw</span>
00183               <span class="comment">// transparent instead.</span>
00184               <span class="keywordflow">if</span> (advance &gt;= 0)
00185               {
00186                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = lX; j &lt; rX; j++)
00187                 {
00188                   <span class="keywordflow">if</span> (CharLine == 0xff)
00189                   {
00190                     mixerFG.Mix (*VRAM);
00191                   }
00192                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CharLine == 0x00)
00193                   {
00194                     mixerBG.Mix (*VRAM);
00195                   }
00196                   <span class="keywordflow">else</span>
00197                   {
00198                     <span class="comment">// @@@ Could be more optimal, probably.</span>
00199                     Tpixel mixedFG = *VRAM;
00200                     mixerFG.Mix (mixedFG);
00201                     mixerBG.Mix (*VRAM);
00202                     
00203                     Tpixmixer3 mixer (G2D, mixedFG, CharLine);
00204                     mixer.Mix (*VRAM);
00205                   }
00206                   VRAM++;
00207                   <span class="keywordflow">if</span> (j &lt; rX-1) CharLine = (*CharImageAlpha++);
00208                 } <span class="comment">/* endfor */</span>
00209               }
00210               <span class="keywordflow">else</span>
00211               {
00212                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = lX; j &lt; rX; j++)
00213                 {
00214                   <span class="keywordflow">if</span> (CharLine == 0xff)
00215                   {
00216                     mixerFG.Mix (*VRAM);
00217                   }
00218                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CharLine != 0x00)
00219                   {
00220                     <span class="comment">// @@@ Could be more optimal, probably.</span>
00221                     Tpixel mixedFG = *VRAM;
00222                     mixerFG.Mix (mixedFG);
00223                     
00224                     Tpixmixer3 mixer (G2D, mixedFG, CharLine);
00225                     mixer.Mix (*VRAM);
00226                   }
00227                   VRAM++;
00228                   <span class="keywordflow">if</span> (j &lt; rX-1) CharLine = (*CharImageAlpha++);
00229                 } <span class="comment">/* endfor */</span>
00230                 <span class="keywordflow">if</span> (advance &lt; 0) advance++;
00231               }
00232             }
00233           }
00234           <span class="keywordflow">else</span>
00235           {
00236             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; charH; i++, cury++)
00237             {
00238               advance = oldAdvance;
00239               p += bbl;
00240               <span class="keywordflow">if</span> ((cury &lt; ClipY1) || (cury &gt;= ClipY2))
00241               {
00242                 <span class="keywordflow">if</span> (advance &lt; 0) advance = MIN(0, advance + (rX - lX));
00243                 <span class="keywordflow">continue</span>;
00244               }
00245               CharImage = p + lBytes;
00246               <span class="keyword">register</span> uint8 CharLine = (*CharImage++) &lt;&lt; shiftX;
00247               <span class="keyword">register</span> Tpixel* VRAM = (Tpixel*)G2D-&gt;<a class="code" href="classcsGraphics2D.html#a28">GetPixelAt</a> (lAbsX, cury);
00248               <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = lX; j &lt; rX; j++)
00249               {
00250                 <span class="keywordflow">if</span> (advance &gt;= 0)
00251                 {
00252                   <span class="keywordflow">if</span> (CharLine &amp; 0x80)
00253                     mixerFG.Mix (*VRAM++);
00254                   <span class="keywordflow">else</span>
00255                     mixerBG.Mix (*VRAM++);
00256                 }
00257                 <span class="keywordflow">else</span>
00258                 {
00259                   <span class="keywordflow">if</span> (CharLine &amp; 0x80)
00260                     mixerFG.Mix (*VRAM++);
00261                   <span class="keywordflow">else</span>
00262                     VRAM++;
00263                   advance++;
00264                 }
00265                 <span class="keywordflow">if</span> ((j &amp; 7) == 7)
00266                   CharLine = (*CharImage++);
00267                 <span class="keywordflow">else</span>
00268                   CharLine += CharLine;
00269               } <span class="comment">/* endfor */</span>
00270             }
00271           }
00272         }
00273         <span class="keywordflow">else</span>
00274         {
00275           <span class="comment">// no clipping</span>
00276           <span class="keywordflow">if</span> (CharImageAlpha)
00277           {
00278             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; charH; i++, cury++)
00279             {
00280               advance = oldAdvance;
00281               <span class="keyword">register</span> Tpixel* VRAM = (Tpixel*)G2D-&gt;<a class="code" href="classcsGraphics2D.html#a28">GetPixelAt</a> (x, cury);
00282               <span class="keyword">register</span> <span class="keywordtype">unsigned</span> pixW = charW;
00283               <span class="keyword">register</span> <span class="keywordtype">int</span> pix;
00284               <span class="keywordflow">for</span> (pix = pixW; pix &gt; 0; pix--)
00285               {
00286                 <span class="keyword">register</span> uint8 CharLine = (*CharImageAlpha++);
00287                 <span class="keywordflow">if</span> (advance &lt; 0)
00288                 {
00289                   <span class="keywordflow">if</span> (CharLine == 0xff)
00290                   {
00291                     mixerFG.Mix (*VRAM);
00292                   }
00293                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CharLine != 0x00)
00294                   {
00295                     <span class="comment">// @@@ Could be more optimal, probably.</span>
00296                     Tpixel mixedFG = *VRAM;
00297                     mixerFG.Mix (mixedFG);
00298                     
00299                     Tpixmixer3 mixer (G2D, mixedFG, CharLine);
00300                     mixer.Mix (*VRAM);
00301                   }
00302                 }
00303                 <span class="keywordflow">else</span>
00304                 {
00305                   <span class="keywordflow">if</span> (CharLine == 0xff)
00306                   {
00307                     mixerFG.Mix (*VRAM);
00308                   }
00309                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CharLine == 0x00)
00310                   {
00311                     mixerBG.Mix (*VRAM);
00312                   }
00313                   <span class="keywordflow">else</span>
00314                   {
00315                     <span class="comment">// @@@ Could be more optimal, probably.</span>
00316                     Tpixel mixedFG = *VRAM;
00317                     mixerFG.Mix (mixedFG);
00318                     mixerBG.Mix (*VRAM);
00319                     
00320                     Tpixmixer3 mixer (G2D, mixedFG, CharLine);
00321                     mixer.Mix (*VRAM);
00322                   }
00323                 }
00324                 <span class="keywordflow">if</span> (advance &lt; 0) advance++;
00325                 VRAM++;
00326               }
00327             }
00328           }
00329           <span class="keywordflow">else</span>
00330           {
00331             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; charH; i++, cury++)
00332             {
00333               <span class="keyword">register</span> Tpixel* VRAM = (Tpixel*)G2D-&gt;<a class="code" href="classcsGraphics2D.html#a28">GetPixelAt</a> (x, cury);
00334               <span class="keyword">register</span> <span class="keywordtype">unsigned</span> pixW = charW;
00335               <span class="keywordflow">while</span> (pixW)
00336               {
00337                 <span class="keyword">register</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> CharLine = *CharImage++;
00338                 <span class="keyword">register</span> <span class="keywordtype">int</span> pix;
00339                 <span class="keywordflow">for</span> (pix = pixW &lt; 8 ? pixW : 8, pixW -= pix; CharLine &amp;&amp; pix; pix--)
00340                 {
00341                   <span class="keywordflow">if</span> (advance &lt; 0)
00342                   {
00343                     <span class="keywordflow">if</span> (CharLine &amp; 0x80)
00344                       mixerFG.Mix (*VRAM++);
00345                     <span class="keywordflow">else</span>
00346                       VRAM++;
00347                     <span class="comment">// Addition is faster than shift, at least on i586+</span>
00348                     CharLine += CharLine;
00349                   }
00350                   <span class="keywordflow">else</span>
00351                   {
00352                     <span class="keywordflow">if</span> (CharLine &amp; 0x80)
00353                       mixerFG.Mix (*VRAM++);
00354                     <span class="keywordflow">else</span>
00355                       mixerBG.Mix (*VRAM++);
00356                     <span class="comment">// Addition is faster than shift, at least on i586+</span>
00357                     CharLine += CharLine;
00358                   }
00359                   <span class="keywordflow">if</span> (advance &lt; 0) advance++;
00360                 } <span class="comment">/* endfor */</span>
00361                 <span class="keywordflow">if</span> (advance &lt; 0)
00362                 {
00363                   VRAM -= advance;
00364                   pix += advance;
00365                 }
00366                 <span class="keywordflow">while</span> (pix--)
00367                   mixerBG.Mix (*VRAM++);
00368               } 
00369             } 
00370           }
00371         } <span class="comment">/* endif */</span>
00372       }
00373   
00374       pen_x += cacheData-&gt;glyphMetrics.advance;
00375       advance += cacheData-&gt;glyphMetrics.advance - (charW + bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o2">left</a>);
00376     }
00377     cache-&gt;PurgeEmptyPlanes ();
00378     
00379   }
00380 };
00381 
00382 <span class="preprocessor">#endif // __CS_CSPLUGINCOMMON_CANVAS_DRAW_TEXT_H___</span>
</pre></div><hr size="1"><address><small>Generated for Crystal Space by 
<a href="http://www.doxygen.org/index.html">doxygen</a> 1.3.9.1 
</small></address> </div></body> </html>
