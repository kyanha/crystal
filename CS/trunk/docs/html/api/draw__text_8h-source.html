<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Crystal Space: csplugincommon/canvas/draw_text.h Source File (Crystal Space Public API Reference)</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<table border="0" cellpadding="0" cellspacing="0" width="100%" class="head">
 <tr heigth="59">
  <td class="head" width="202" valign="bottom" style="padding-left:0;"><a href="http://www.crystalspace3d.org/"><img src="csblur.png" width="236" height="59" alt="CrystalSpace" border="0"></a></td>
  <td class="head"><h2>Public API Reference</h2></td>
 </tr>
 <tr heigth="11">
  <td colspan="2" class="headshadow" valign="top" style="padding-left:0;"><img src="csblurb.png" width="236" height="11" alt="" border="0"></td>
 </tr>
</table>
<div class="content">
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000005.html">csplugincommon</a>&nbsp;/&nbsp;<a class="el" href="dir_000006.html">canvas</a></div>
<h1>draw_text.h</h1><a href="draw__text_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">    Copyright (C) 2004 by Jorrit Tyberghein</span>
00003 <span class="comment">              (C) 2004 by Frank Richter</span>
00004 <span class="comment"></span>
00005 <span class="comment">    This library is free software; you can redistribute it and/or</span>
00006 <span class="comment">    modify it under the terms of the GNU Library General Public</span>
00007 <span class="comment">    License as published by the Free Software Foundation; either</span>
00008 <span class="comment">    version 2 of the License, or (at your option) any later version.</span>
00009 <span class="comment"></span>
00010 <span class="comment">    This library is distributed in the hope that it will be useful,</span>
00011 <span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00012 <span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00013 <span class="comment">    Library General Public License for more details.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    You should have received a copy of the GNU Library General Public</span>
00016 <span class="comment">    License along with this library; if not, write to the Free</span>
00017 <span class="comment">    Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
00018 <span class="comment">*/</span>
00019 
00020 <span class="preprocessor">#ifndef __CS_CSPLUGINCOMMON_CANVAS_DRAW_TEXT_H__</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#define __CS_CSPLUGINCOMMON_CANVAS_DRAW_TEXT_H__</span>
00022 <span class="preprocessor"></span>
00027 <span class="preprocessor">#include "<a class="code" href="csuctransform_8h.html">csutil/csuctransform.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="draw__common_8h.html">draw_common.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="softfontcache_8h.html">csplugincommon/canvas/softfontcache.h</a>"</span>
00030 
00041 <span class="keyword">template</span>&lt;<span class="keyword">class</span> Tpixel, <span class="keyword">class</span> Tpixmixer1, <span class="keyword">class</span> Tpixmixer2, <span class="keyword">class</span> Tpixmixer3&gt;
<a name="l00042"></a><a class="code" href="classcsG2DDrawText.html">00042</a> <span class="keyword">class </span><a class="code" href="classcsG2DDrawText.html">csG2DDrawText</a>
00043 {
00044 <span class="keyword">public</span>:
00045   <span class="keyword">static</span> <span class="keywordtype">void</span> DrawText (<a class="code" href="classcsSoftFontCache.html">csSoftFontCache</a>* cache, <a class="code" href="structiFont.html">iFont</a>* font, <span class="keywordtype">int</span> pen_x, <span class="keywordtype">int</span> pen_y,
00046     Tpixel fg, uint8 alphaFG, Tpixel bg, uint8 alphaBG, <span class="keyword">const</span> <a class="code" href="group__util.html#ga19">utf8_char</a> *text, 
00047     <a class="code" href="group__util.html#ga16">uint</a> flags)
00048   {
00049     <a class="code" href="classcsGraphics2D.html">csGraphics2D</a>* G2D = cache-&gt;<a class="code" href="classcsSoftFontCache.html#o1">G2D</a>;
00050     <span class="keyword">const</span> <span class="keywordtype">int</span> ClipX1 = cache-&gt;<a class="code" href="classcsFontCache.html#o0">ClipX1</a>, ClipY1 = cache-&gt;<a class="code" href="classcsFontCache.html#o1">ClipY1</a>, 
00051       ClipX2 = cache-&gt;<a class="code" href="classcsFontCache.html#o2">ClipX2</a>, ClipY2 = cache-&gt;<a class="code" href="classcsFontCache.html#o3">ClipY2</a>;
00052     Tpixmixer1 mixerFG (G2D, fg, alphaFG);
00053     Tpixmixer2 mixerBG (G2D, bg, alphaBG);
00054     
00055     <span class="keywordflow">if</span> (!font)
00056       <span class="keywordflow">return</span>;
00057     
00058     <span class="keywordflow">if</span> (!(flags &amp; CS_WRITE_BASELINE)) pen_y += font-&gt;<a class="code" href="structiFont.html#a11">GetAscent</a> ();
00059   
00060     csSoftFontCache::KnownFont* knownFont = cache-&gt;<a class="code" href="classcsFontCache.html#a4">GetCachedFont</a> (font);
00061     <span class="keywordflow">if</span> (knownFont == 0) knownFont = cache-&gt;<a class="code" href="classcsFontCache.html#a5">CacheFont</a> (font);
00062   
00063     size_t textLen = strlen ((<span class="keywordtype">char</span>*)text);
00064     <span class="keywordtype">int</span> charW, charH, advance = 0;
00065     <span class="keywordtype">bool</span> firstchar = <span class="keyword">true</span>;
00066     <span class="keywordflow">while</span> (textLen &gt; 0)
00067     {
00068       <a class="code" href="group__util.html#ga21">utf32_char</a> glyph;
00069       <span class="keywordtype">int</span> skip = <a class="code" href="classcsUnicodeTransform.html#z580_0">csUnicodeTransform::UTF8Decode</a> (text, textLen, glyph, 0);
00070       <span class="keywordflow">if</span> (skip == 0) <span class="keywordflow">break</span>;
00071   
00072       text += skip;
00073       textLen -= skip;
00074   
00075       csSoftFontCache::SoftGlyphCacheData* cacheData = 
00076         (csSoftFontCache::SoftGlyphCacheData*)cache-&gt;<a class="code" href="classcsFontCache.html#a2">CacheGlyph</a> (knownFont, 
00077         glyph, flags);
00078       <span class="keywordflow">if</span> (!cacheData-&gt;hasGlyph) 
00079       {
00080         <span class="comment">// fall back to the default glyph (CS_FONT_DEFAULT_GLYPH)</span>
00081         cacheData = (csSoftFontCache::SoftGlyphCacheData*)cache-&gt;<a class="code" href="classcsFontCache.html#a2">CacheGlyph</a> (
00082           knownFont, <a class="code" href="group__gfx2d.html#ga15">CS_FONT_DEFAULT_GLYPH</a>, flags);
00083         <span class="keywordflow">if</span> (!cacheData-&gt;hasGlyph) <span class="keywordflow">continue</span>;
00084       }
00085   
00086       <span class="keyword">register</span> uint8 *CharImageAlpha = cacheData-&gt;glyphAlphaData;
00087       <span class="keyword">register</span> uint8 *CharImage = cacheData-&gt;glyphData;
00088       <span class="keywordflow">if</span> ((!CharImage) &amp;&amp; (!CharImageAlpha))
00089         <span class="keywordflow">continue</span>;
00090   
00091       <a class="code" href="structcsBitmapMetrics.html">csBitmapMetrics</a>* bmetrics;
00092       <span class="keywordflow">if</span> (CharImageAlpha)
00093       {
00094         bmetrics = &amp;cacheData-&gt;alphaMetrics;
00095       }
00096       <span class="keywordflow">else</span>
00097       {
00098         bmetrics = &amp;cacheData-&gt;bitmapMetrics;
00099       }
00100       charW = bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o0">width</a>;
00101       charH = bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o1">height</a>;
00102       
00103       <span class="keywordtype">int</span> y = pen_y - bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o3">top</a>;
00104       
00105       <span class="comment">// If we are advancing more than the last char was wide, we have to</span>
00106       <span class="comment">// fill the 'gap' with bg.</span>
00107       
00108       <span class="keywordtype">int</span> x = pen_x - (advance &gt; 0 ? advance : 0) + (bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o2">left</a> &lt; 0 ? bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o2">left</a> : 0);
00109       advance += bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o2">left</a>;
00110       
00111       <span class="comment">// Hack: in case the first char has a negative left bitmap offset,</span>
00112       <span class="comment">// some of the background isn't drawn. Fix that.</span>
00113       <span class="keywordflow">if</span> (firstchar)
00114       {
00115         <span class="keywordflow">if</span> (advance &lt; 0)
00116         {
00117           advance = 0;
00118         }
00119         firstchar = <span class="keyword">false</span>;
00120       }
00121      
00122       <span class="keywordflow">if</span> (alphaBG != 0)
00123       {
00124         <span class="keywordflow">while</span> (advance &gt; 0)
00125         {
00126           <span class="keywordflow">if</span> (x &gt;= ClipX2)
00127             <span class="keywordflow">return</span>;
00128     
00129           <span class="keywordtype">int</span> cury = y;
00130           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; charH; i++, cury++)
00131           {
00132             <span class="keywordflow">if</span> ((cury &lt; ClipY1) || (cury &gt;= ClipY2)) <span class="keywordflow">continue</span>;
00133             <span class="keyword">register</span> Tpixel *VRAM = (Tpixel*)G2D-&gt;<a class="code" href="classcsGraphics2D.html#a28">GetPixelAt</a> (x, cury);
00134             <span class="keywordflow">if</span> (x &gt;= ClipX1) mixerBG.Mix (*VRAM);
00135           }
00136           x++; advance--;
00137         }
00138       }
00139       <span class="keywordflow">else</span>
00140       {
00141         <span class="keywordflow">if</span> (advance &gt; 0)
00142         {
00143           x += advance;
00144           advance = 0;
00145         }
00146       }
00147   
00148       <span class="keywordflow">if</span> (x &gt;= ClipX2)
00149         <span class="keywordflow">return</span>;
00150   
00151       <span class="comment">// If character is completely outside the clipping rectangle, continue</span>
00152       <span class="keywordflow">if</span> (!((x + charW &lt;= ClipX1) || (x &gt;= ClipX2)
00153        || (y + charH &lt;= ClipY1) || (y &gt;= ClipY2)))
00154       {
00155         <span class="keywordtype">int</span> cury = y;
00156     
00157         <span class="keywordtype">int</span> oldAdvance = advance;
00158         <span class="comment">// If character should not be clipped, go the fast path</span>
00159         <span class="keywordflow">if</span> ((x &lt; ClipX1) || (x + charW &gt;= ClipX2)
00160          || (y &lt; ClipY1) || (y + charH &gt;= ClipY2))
00161         {
00162           <span class="comment">// Perform full clipping</span>
00163           <span class="keywordtype">int</span> lX = x &lt; ClipX1 ? ClipX1 - x : 0;
00164           <span class="keywordtype">int</span> rX = x + charW &gt;= ClipX2 ? ClipX2 - x : charW;
00165           <span class="keywordtype">int</span> lBytes = CharImageAlpha ? lX : lX &gt;&gt; 3;
00166           <span class="keywordtype">int</span> shiftX = CharImageAlpha ? 0 : lX &amp; 7;
00167           <span class="keywordtype">int</span> bbl = CharImageAlpha ? charW : (charW + 7) / 8; <span class="comment">// bytes per line</span>
00168           <span class="keywordtype">int</span> lAbsX = x + lX;
00169           uint8 *p = CharImageAlpha ? CharImageAlpha - bbl : CharImage - bbl;
00170           
00171           <span class="keywordflow">if</span> (CharImageAlpha)
00172           {
00173             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; charH; i++, cury++)
00174             {
00175               advance = oldAdvance;
00176               p += bbl;
00177               <span class="keywordflow">if</span> ((cury &lt; ClipY1) || (cury &gt;= ClipY2)) 
00178               {
00179                 <span class="keywordflow">if</span> (advance &lt; 0) advance = MIN(0, advance + (rX - lX));
00180                 <span class="keywordflow">continue</span>;
00181               }
00182               CharImageAlpha = p + lBytes;
00183               <span class="keyword">register</span> uint8 CharLine = (*CharImageAlpha++) &lt;&lt; shiftX;
00184               <span class="keyword">register</span> Tpixel* VRAM = (Tpixel*)G2D-&gt;<a class="code" href="classcsGraphics2D.html#a28">GetPixelAt</a> (lAbsX, cury);
00185               <span class="comment">// If we are advancing less than the last char was wide, the current</span>
00186               <span class="comment">// and last chars overlap. So we can't draw opaque, but have to draw</span>
00187               <span class="comment">// transparent instead.</span>
00188               <span class="keywordflow">if</span> (advance &gt;= 0)
00189               {
00190                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = lX; j &lt; rX; j++)
00191                 {
00192                   <span class="keywordflow">if</span> (CharLine == 0xff)
00193                   {
00194                     mixerFG.Mix (*VRAM);
00195                   }
00196                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CharLine == 0x00)
00197                   {
00198                     mixerBG.Mix (*VRAM);
00199                   }
00200                   <span class="keywordflow">else</span>
00201                   {
00202                     <span class="comment">// @@@ Could be more optimal, probably.</span>
00203                     Tpixel mixedFG = *VRAM;
00204                     mixerFG.Mix (mixedFG);
00205                     mixerBG.Mix (*VRAM);
00206                     
00207                     Tpixmixer3 mixer (G2D, mixedFG, CharLine);
00208                     mixer.Mix (*VRAM);
00209                   }
00210                   VRAM++;
00211                   <span class="keywordflow">if</span> (j &lt; rX-1) CharLine = (*CharImageAlpha++);
00212                 } <span class="comment">/* endfor */</span>
00213               }
00214               <span class="keywordflow">else</span>
00215               {
00216                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = lX; j &lt; rX; j++)
00217                 {
00218                   <span class="keywordflow">if</span> (CharLine == 0xff)
00219                   {
00220                     mixerFG.Mix (*VRAM);
00221                   }
00222                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CharLine != 0x00)
00223                   {
00224                     <span class="comment">// @@@ Could be more optimal, probably.</span>
00225                     Tpixel mixedFG = *VRAM;
00226                     mixerFG.Mix (mixedFG);
00227                     
00228                     Tpixmixer3 mixer (G2D, mixedFG, CharLine);
00229                     mixer.Mix (*VRAM);
00230                   }
00231                   VRAM++;
00232                   <span class="keywordflow">if</span> (j &lt; rX-1) CharLine = (*CharImageAlpha++);
00233                 } <span class="comment">/* endfor */</span>
00234                 <span class="keywordflow">if</span> (advance &lt; 0) advance++;
00235               }
00236             }
00237           }
00238           <span class="keywordflow">else</span>
00239           {
00240             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; charH; i++, cury++)
00241             {
00242               advance = oldAdvance;
00243               p += bbl;
00244               <span class="keywordflow">if</span> ((cury &lt; ClipY1) || (cury &gt;= ClipY2))
00245               {
00246                 <span class="keywordflow">if</span> (advance &lt; 0) advance = MIN(0, advance + (rX - lX));
00247                 <span class="keywordflow">continue</span>;
00248               }
00249               CharImage = p + lBytes;
00250               <span class="keyword">register</span> uint8 CharLine = (*CharImage++) &lt;&lt; shiftX;
00251               <span class="keyword">register</span> Tpixel* VRAM = (Tpixel*)G2D-&gt;<a class="code" href="classcsGraphics2D.html#a28">GetPixelAt</a> (lAbsX, cury);
00252               <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = lX; j &lt; rX; j++)
00253               {
00254                 <span class="keywordflow">if</span> (advance &gt;= 0)
00255                 {
00256                   <span class="keywordflow">if</span> (CharLine &amp; 0x80)
00257                     mixerFG.Mix (*VRAM++);
00258                   <span class="keywordflow">else</span>
00259                     mixerBG.Mix (*VRAM++);
00260                 }
00261                 <span class="keywordflow">else</span>
00262                 {
00263                   <span class="keywordflow">if</span> (CharLine &amp; 0x80)
00264                     mixerFG.Mix (*VRAM++);
00265                   <span class="keywordflow">else</span>
00266                     VRAM++;
00267                   advance++;
00268                 }
00269                 <span class="keywordflow">if</span> ((j &amp; 7) == 7)
00270                   CharLine = (*CharImage++);
00271                 <span class="keywordflow">else</span>
00272                   CharLine += CharLine;
00273               } <span class="comment">/* endfor */</span>
00274             }
00275           }
00276         }
00277         <span class="keywordflow">else</span>
00278         {
00279           <span class="comment">// no clipping</span>
00280           <span class="keywordflow">if</span> (CharImageAlpha)
00281           {
00282             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; charH; i++, cury++)
00283             {
00284               advance = oldAdvance;
00285               <span class="keyword">register</span> Tpixel* VRAM = (Tpixel*)G2D-&gt;<a class="code" href="classcsGraphics2D.html#a28">GetPixelAt</a> (x, cury);
00286               <span class="keyword">register</span> <span class="keywordtype">unsigned</span> pixW = charW;
00287               <span class="keyword">register</span> <span class="keywordtype">int</span> pix;
00288               <span class="keywordflow">for</span> (pix = pixW; pix &gt; 0; pix--)
00289               {
00290                 <span class="keyword">register</span> uint8 CharLine = (*CharImageAlpha++);
00291                 <span class="keywordflow">if</span> (advance &lt; 0)
00292                 {
00293                   <span class="keywordflow">if</span> (CharLine == 0xff)
00294                   {
00295                     mixerFG.Mix (*VRAM);
00296                   }
00297                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CharLine != 0x00)
00298                   {
00299                     <span class="comment">// @@@ Could be more optimal, probably.</span>
00300                     Tpixel mixedFG = *VRAM;
00301                     mixerFG.Mix (mixedFG);
00302                     
00303                     Tpixmixer3 mixer (G2D, mixedFG, CharLine);
00304                     mixer.Mix (*VRAM);
00305                   }
00306                 }
00307                 <span class="keywordflow">else</span>
00308                 {
00309                   <span class="keywordflow">if</span> (CharLine == 0xff)
00310                   {
00311                     mixerFG.Mix (*VRAM);
00312                   }
00313                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CharLine == 0x00)
00314                   {
00315                     mixerBG.Mix (*VRAM);
00316                   }
00317                   <span class="keywordflow">else</span>
00318                   {
00319                     <span class="comment">// @@@ Could be more optimal, probably.</span>
00320                     Tpixel mixedFG = *VRAM;
00321                     mixerFG.Mix (mixedFG);
00322                     mixerBG.Mix (*VRAM);
00323                     
00324                     Tpixmixer3 mixer (G2D, mixedFG, CharLine);
00325                     mixer.Mix (*VRAM);
00326                   }
00327                 }
00328                 <span class="keywordflow">if</span> (advance &lt; 0) advance++;
00329                 VRAM++;
00330               }
00331             }
00332           }
00333           <span class="keywordflow">else</span>
00334           {
00335             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; charH; i++, cury++)
00336             {
00337               <span class="keyword">register</span> Tpixel* VRAM = (Tpixel*)G2D-&gt;<a class="code" href="classcsGraphics2D.html#a28">GetPixelAt</a> (x, cury);
00338               <span class="keyword">register</span> <span class="keywordtype">unsigned</span> pixW = charW;
00339               <span class="keywordflow">while</span> (pixW)
00340               {
00341                 <span class="keyword">register</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> CharLine = *CharImage++;
00342                 <span class="keyword">register</span> <span class="keywordtype">int</span> pix;
00343                 <span class="keywordflow">for</span> (pix = pixW &lt; 8 ? pixW : 8, pixW -= pix; CharLine &amp;&amp; pix; pix--)
00344                 {
00345                   <span class="keywordflow">if</span> (advance &lt; 0)
00346                   {
00347                     <span class="keywordflow">if</span> (CharLine &amp; 0x80)
00348                       mixerFG.Mix (*VRAM++);
00349                     <span class="keywordflow">else</span>
00350                       VRAM++;
00351                     <span class="comment">// Addition is faster than shift, at least on i586+</span>
00352                     CharLine += CharLine;
00353                   }
00354                   <span class="keywordflow">else</span>
00355                   {
00356                     <span class="keywordflow">if</span> (CharLine &amp; 0x80)
00357                       mixerFG.Mix (*VRAM++);
00358                     <span class="keywordflow">else</span>
00359                       mixerBG.Mix (*VRAM++);
00360                     <span class="comment">// Addition is faster than shift, at least on i586+</span>
00361                     CharLine += CharLine;
00362                   }
00363                   <span class="keywordflow">if</span> (advance &lt; 0) advance++;
00364                 } <span class="comment">/* endfor */</span>
00365                 <span class="keywordflow">if</span> (advance &lt; 0)
00366                 {
00367                   VRAM -= advance;
00368                   pix += advance;
00369                 }
00370                 <span class="keywordflow">while</span> (pix--)
00371                   mixerBG.Mix (*VRAM++);
00372               } 
00373             } 
00374           }
00375         } <span class="comment">/* endif */</span>
00376       }
00377   
00378       pen_x += cacheData-&gt;glyphMetrics.advance;
00379       advance += cacheData-&gt;glyphMetrics.advance - (charW + bmetrics-&gt;<a class="code" href="structcsBitmapMetrics.html#o2">left</a>);
00380     }
00381     cache-&gt;<a class="code" href="classcsFontCache.html#a9">PurgeEmptyPlanes</a> ();
00382     
00383   }
00384 };
00385 
00388 <span class="preprocessor">#endif // __CS_CSPLUGINCOMMON_CANVAS_DRAW_TEXT_H___</span>
</pre></div><hr size="1"><address><small>Generated for Crystal Space by 
<a href="http://www.doxygen.org/index.html">doxygen</a> 1.3.9.1 
</small></address> </div></body> </html>
