<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Crystal Space: csutil/csprocessorcap.h Source File (Crystal Space Public API Reference)</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<table border="0" cellpadding="0" cellspacing="0" width="100%" class="head">
 <tr heigth="59">
  <td class="head" width="202" valign="bottom" style="padding-left:0;"><a href="http://www.crystalspace3d.org/"><img src="csblur.png" width="236" height="59" alt="CrystalSpace" border="0"></a></td>
  <td class="head"><h2>Public API Reference</h2></td>
 </tr>
 <tr heigth="11">
  <td colspan="2" class="headshadow" valign="top" style="padding-left:0;"><img src="csblurb.png" width="236" height="11" alt="" border="0"></td>
 </tr>
</table>
<div class="content">
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000022.html">csutil</a></div>
<h1>csprocessorcap.h</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">  Copyright (C) 2002 by Marten Svanfeldt</span>
00003 <span class="comment"></span>
00004 <span class="comment">  This library is free software; you can redistribute it and/or</span>
00005 <span class="comment">  modify it under the terms of the GNU Library General Public</span>
00006 <span class="comment">  License as published by the Free Software Foundation; either</span>
00007 <span class="comment">  version 2 of the License, or (at your option) any later version.</span>
00008 <span class="comment"></span>
00009 <span class="comment">  This library is distributed in the hope that it will be useful,</span>
00010 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00011 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00012 <span class="comment">  Library General Public License for more details.</span>
00013 <span class="comment"></span>
00014 <span class="comment">  You should have received a copy of the GNU Library General Public</span>
00015 <span class="comment">  License along with this library; if not, write to the Free</span>
00016 <span class="comment">  Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
00017 <span class="comment">*/</span>
00018 
00019 <span class="preprocessor">#ifndef __CS_PROCESSORCAP_H__</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#define __CS_PROCESSORCAP_H__</span>
00021 <span class="preprocessor"></span>
00022 <span class="preprocessor">#include "csextern.h"</span>
00023 
<a name="l00028"></a><a class="code" href="classcsProcessorCapability.html">00028</a> <span class="keyword">class </span>CS_CSUTIL_EXPORT csProcessorCapability
00029 {
00030 <span class="keyword">public</span>:
00031 
<a name="l00035"></a><a class="code" href="classcsProcessorCapability.html#a0">00035</a>   <a class="code" href="classcsProcessorCapability.html#a0">csProcessorCapability</a> () 
00036   {
00037   }
00038 
<a name="l00042"></a><a class="code" href="classcsProcessorCapability.html#a1">00042</a>   <a class="code" href="classcsProcessorCapability.html#a1">~csProcessorCapability</a> ()
00043   {
00044   }
00045 
<a name="l00049"></a><a class="code" href="classcsProcessorCapability.html#e0">00049</a>   <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classcsProcessorCapability.html#e0">Initialize</a> ()
00050   {
00051     <span class="keywordflow">if</span> (isInitialized)
00052       <span class="keywordflow">return</span>;
00053 
00054 <span class="preprocessor">#ifdef CS_PROCESSOR_X86</span>
00055 <span class="preprocessor"></span>    CheckX86Processor ();
00056 <span class="preprocessor">#else</span>
00057 <span class="preprocessor"></span>    mmxSupported = <span class="keyword">false</span>;
00058     sseSupported = <span class="keyword">false</span>;
00059     processorName[0] = 0;
00060 <span class="preprocessor">#endif</span>
00061 <span class="preprocessor"></span>  }
00062 
00063   <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">bool</span> HasMMX ()
00064   {
00065     <a class="code" href="classcsProcessorCapability.html#e0">Initialize</a> ();
00066 
00067     <span class="keywordflow">return</span> mmxSupported;
00068   }
00069 
00070   <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">bool</span> HasSSE ()
00071   {
00072     <a class="code" href="classcsProcessorCapability.html#e0">Initialize</a> ();
00073 
00074     <span class="keywordflow">return</span> sseSupported;
00075   }
00076 
00077   <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* GetProcessorName ()
00078   {
00079     <a class="code" href="classcsProcessorCapability.html#e0">Initialize</a> ();
00080 
00081     <span class="keywordflow">return</span> processorName;
00082   }
00083 
00084 <span class="keyword">private</span>:
00085 
00087   <span class="keyword">static</span> <span class="keywordtype">bool</span> isInitialized;
00088 
00090   <span class="keyword">static</span> <span class="keywordtype">bool</span> mmxSupported;
00091 
00093   <span class="keyword">static</span> <span class="keywordtype">bool</span> sseSupported;
00094 
00096   <span class="keyword">static</span> <span class="keywordtype">bool</span> AMD3dnowSupported;
00097   
00099   <span class="keyword">static</span> <span class="keywordtype">char</span> processorName[16];
00100 
00101 <span class="preprocessor">#if defined(CS_PROCESSOR_X86) &amp;&amp; (CS_PROCESSOR_SIZE == 32)</span>
00102 <span class="preprocessor"></span>
00106   <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> CheckX86Processor ()
00107   {
00108     int32 capFlags = 0;
00109     <span class="keywordtype">int</span> CPUnum;
00110     <span class="keywordtype">int</span> maxEax = 0;
00111     <span class="keyword">const</span> <span class="keywordtype">char</span>* procName = processorName;
00112 
00113     <span class="keywordtype">bool</span> have_cpuid;
00114 
00115 <span class="preprocessor">    #if defined(CS_COMPILER_MSVC)</span>
00116 <span class="preprocessor"></span>    __asm
00117     {
00118       <span class="comment">// save vars</span>
00119         push        eax
00120         push        ebx
00121         push        esi
00122 
00123         <span class="comment">//detect 386/486</span>
00124         pushfd
00125         pop         eax                       <span class="comment">//get EFLAGS</span>
00126         mov         ebx, eax                  <span class="comment">//save original EFLAGS</span>
00127         xor         eax, 40000h               <span class="comment">//toggle AC bit</span>
00128         push        eax                       <span class="comment">//copy to stack</span>
00129         popfd                                 <span class="comment">//copy to EFLAGS</span>
00130         pushfd
00131         pop         eax                       <span class="comment">//get EFLAGS again</span>
00132         xor         eax, ebx                  <span class="comment">//check AC bit</span>
00133         mov         CPUnum, 386               <span class="comment">//386</span>
00134         je          end_detect                <span class="comment">//is a 386, stop detection</span>
00135         push        ebx                       <span class="comment">//restore EFLAGS</span>
00136         popfd
00137 
00138         <span class="comment">//detect 486/pentium+</span>
00139         pushfd                                <span class="comment">//get EFLAGS</span>
00140         pop         eax
00141         mov         ecx, eax
00142         xor         eax, 200000h              <span class="comment">//toggle ID bit in EFLAGS</span>
00143         push        eax                       <span class="comment">//save new EFLAGS value on stack                                                                          </span>
00144         popfd                                 <span class="comment">//replace current EFLAGS value</span>
00145         pushfd                                <span class="comment">//get new EFLAGS</span>
00146         pop         eax                       <span class="comment">//store new EFLAGS in EAX</span>
00147         xor         eax, ecx                  <span class="comment">//can not toggle ID bit,</span>
00148         mov         CPUnum, 486
00149         jz          end_detect                <span class="comment">//processor=80486</span>
00150         mov         CPUnum, 586               <span class="comment">//586+</span>
00151 
00152         mov         have_cpuid, 1             <span class="comment">//we have cpuid</span>
00153 
00154         <span class="comment">//check number of cpuid instructions</span>
00155         mov         eax, 0
00156         cpuid         
00157         mov         maxEax, eax               <span class="comment">//save the maximum eax for cpuid</span>
00158 
00159         <span class="comment">//save MFT string</span>
00160         mov         esi, procName
00161         mov         [esi+0], ebx
00162         mov         [esi+4], edx
00163         mov         [esi+8], ecx
00164         mov         [esi+12], 0
00165 
00166         test        maxEax, 1
00167         jz          end_detect
00168 
00169         <span class="comment">//get flagstring</span>
00170         mov         eax, 1
00171         cpuid
00172         mov         capFlags, edx
00173 
00174 end_detect:
00175 
00176         pop esi
00177         pop ebx
00178         pop eax
00179     }
00180 <span class="preprocessor">    #elif defined(CS_COMPILER_GCC)</span>
00181 <span class="preprocessor"></span>    __asm__(
00182     <span class="comment">//detect 386/486</span>
00183     <span class="stringliteral">"  pushfl                           \n"</span>
00184     <span class="stringliteral">"  popl         %%eax               \n"</span>      <span class="comment">//get EFLAGS</span>
00185     <span class="stringliteral">"  movl         %%eax, %%ebx        \n"</span>      <span class="comment">//save original EFLAGS</span>
00186     <span class="stringliteral">"  xorl         $0x40000, %%eax     \n"</span>      <span class="comment">//toggle AC bit</span>
00187     <span class="stringliteral">"  pushl        %%eax               \n"</span>      <span class="comment">//copy to stack</span>
00188     <span class="stringliteral">"  popfl                            \n"</span>      <span class="comment">//copy to EFLAGS</span>
00189     <span class="stringliteral">"  pushfl                           \n"</span>
00190     <span class="stringliteral">"  popl         %%eax               \n"</span>      <span class="comment">//get EFLAGS again</span>
00191     <span class="stringliteral">"  xorl         %%ebx, %%eax        \n"</span>      <span class="comment">//check AC bit</span>
00192     <span class="stringliteral">"  movl         $386,%0             \n"</span>      <span class="comment">//386</span>
00193     <span class="stringliteral">"  je           1f                  \n"</span>      <span class="comment">//is a 386, stop detection</span>
00194     <span class="stringliteral">"  pushl        %%ebx               \n"</span>      <span class="comment">//restore EFLAGS</span>
00195     <span class="stringliteral">"  popfl                            \n"</span>
00196     <span class="comment">//detect 486/pentium+</span>
00197     <span class="stringliteral">"  pushfl                           \n"</span>      <span class="comment">//get EFLAGS</span>
00198     <span class="stringliteral">"  popl         %%eax               \n"</span>
00199     <span class="stringliteral">"  movl         %%eax, %%ecx        \n"</span>
00200     <span class="stringliteral">"  xorl         $0x200000,%%eax     \n"</span>      <span class="comment">//toggle ID bit in EFLAGS</span>
00201     <span class="stringliteral">"  pushl        %%eax               \n"</span>      <span class="comment">//save new EFLAGS value on stack</span>
00202     <span class="stringliteral">"  popfl                            \n"</span>      <span class="comment">//replace current EFLAGS value</span>
00203     <span class="stringliteral">"  pushfl                           \n"</span>      <span class="comment">//get new EFLAGS</span>
00204     <span class="stringliteral">"  popl         %%eax               \n"</span>      <span class="comment">//store new EFLAGS in EAX</span>
00205     <span class="stringliteral">"  xorl         %%eax, %%ecx        \n"</span>      <span class="comment">//can not toggle ID bit,</span>
00206     <span class="stringliteral">"  movl         $486,%0             \n"</span>
00207     <span class="stringliteral">"  jz           1f                  \n"</span>      <span class="comment">//processor=80486</span>
00208     <span class="stringliteral">"  movl         $586,%0             \n"</span>      <span class="comment">//586+</span>
00209     <span class="stringliteral">"  movl         $1,%1               \n"</span>      <span class="comment">//we have cpuid</span>
00210     <span class="comment">//check number of cpuid instructions</span>
00211     <span class="stringliteral">"  xorl         %%eax,%%eax         \n"</span>      <span class="comment">// thebolt: this was a movl $0,%eax</span>
00212     <span class="stringliteral">"  cpuid                            \n"</span>
00213     <span class="stringliteral">"  movl         %%eax,%2            \n"</span>      <span class="comment">//save the maximum eax for cpuid</span>
00214     <span class="comment">//save MFT string</span>
00215     <span class="stringliteral">"  movl         %4,%%esi            \n"</span>
00216     <span class="stringliteral">"  movl         %%ebx,0(%%esi)      \n"</span>
00217     <span class="stringliteral">"  movl         %%edx,4(%%esi)      \n"</span>
00218     <span class="stringliteral">"  movl         %%ecx,8(%%esi)      \n"</span>
00219     <span class="stringliteral">"  movl         $0,12(%%esi)        \n"</span>
00220     <span class="stringliteral">"  testl        $1,%2               \n"</span>
00221     <span class="stringliteral">"  jz           1f                  \n"</span>
00222     <span class="comment">//get flagstring</span>
00223     <span class="stringliteral">"  movl         $1,%%eax            \n"</span>
00224     <span class="stringliteral">"  cpuid                            \n"</span>
00225     <span class="stringliteral">"  movl         %%edx,%3            \n"</span>
00226     <span class="stringliteral">"1:                                 \n"</span>
00227     : <span class="stringliteral">"=g"</span> (CPUnum), <span class="stringliteral">"=g"</span> (have_cpuid), <span class="stringliteral">"=g"</span> (maxEax), <span class="stringliteral">"=g"</span> (capFlags)
00228     : <span class="stringliteral">"g"</span> (procName), <span class="stringliteral">"2"</span> (maxEax)
00229     : <span class="stringliteral">"eax"</span>, <span class="stringliteral">"ebx"</span>, <span class="stringliteral">"ecx"</span>, <span class="stringliteral">"edx"</span>, <span class="stringliteral">"esi"</span>);
00230 
00231 <span class="preprocessor">    #endif //CS_COMPILER_MSVC/GCC</span>
00232 <span class="preprocessor"></span>    mmxSupported = capFlags &amp; (1&lt;&lt;23);
00233     sseSupported = capFlags &amp; (1&lt;&lt;25);
00234     <span class="comment">//AMD3dnowSupported = capFlags &amp; (1&lt;&lt;31);</span>
00235   }
00236 <span class="preprocessor">#else //CS_PROCESSOR_X86</span>
00237 <span class="preprocessor"></span>  <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> CheckX86Processor() {}
00238 <span class="preprocessor">#endif //CS_PROCESSOR_X86</span>
00239 <span class="preprocessor"></span>};
00240 
00241 <span class="preprocessor">#endif //__CS_PROCESSORCAP_H__</span>
</pre></div><hr size="1"><address><small>Generated for Crystal Space by 
<a href="http://www.doxygen.org/index.html">doxygen</a> 1.3.9.1 
</small></address> </div></body> </html>
