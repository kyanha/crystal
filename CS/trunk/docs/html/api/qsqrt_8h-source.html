<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>qsqrt.h Source File (Crystal Space Public API Reference)</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<table border="0" cellpadding="0" cellspacing="0" width="100%" class="head">
 <tr heigth="59">
  <td class="head" width="202" valign="bottom" style="padding-left:0;"><a href="http://crystal.sourceforge.net/"><img src="csblur.png" width="236" height="59" alt="CrystalSpace" border="0"></a></td>
  <td class="head"><h2>Public API Reference</h2></td>
 </tr>
 <tr heigth="11">
  <td colspan="2" class="headshadow" valign="top" style="padding-left:0;"><img src="csblurb.png" width="236" height="11" alt="" border="0"></td>
 </tr>
</table>
<div class="content">
<!-- Generated by Doxygen 1.2.18 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>qsqrt.h</h1><a href="qsqrt_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment">    Copyright (C) 2000 by Andrew Zabolotny (Intel version)</span>
00003 <span class="comment">    Copyright (C) 2002 by Matthew Reda &lt;reda@mac.com&gt; (PowerPC version)</span>
00004 <span class="comment">    Fast computation of sqrt(x) and 1/sqrt(x)</span>
00005 <span class="comment">  </span>
00006 <span class="comment">    This library is free software; you can redistribute it and/or</span>
00007 <span class="comment">    modify it under the terms of the GNU Library General Public</span>
00008 <span class="comment">    License as published by the Free Software Foundation; either</span>
00009 <span class="comment">    version 2 of the License, or (at your option) any later version.</span>
00010 <span class="comment">  </span>
00011 <span class="comment">    This library is distributed in the hope that it will be useful,</span>
00012 <span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
00013 <span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
00014 <span class="comment">    Library General Public License for more details.</span>
00015 <span class="comment">  </span>
00016 <span class="comment">    You should have received a copy of the GNU Library General Public</span>
00017 <span class="comment">    License along with this library; if not, write to the Free</span>
00018 <span class="comment">    Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
00019 <span class="comment">*/</span>
00020 
00029 <span class="preprocessor">#ifndef __CS_QSQRT_H__</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#define __CS_QSQRT_H__</span>
00031 <span class="preprocessor"></span>
00039 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__floating__point.html#a5">qsqrt</a> (<span class="keywordtype">float</span> x);
00040 
00048 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__floating__point.html#a6">qisqrt</a> (<span class="keywordtype">float</span> x);
00049 
00052 <span class="preprocessor">#if (!defined (CS_NO_QSQRT)) &amp;&amp; defined (PROC_X86) &amp;&amp; defined (COMP_GCC)</span>
00053 <span class="preprocessor"></span>
00071 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__floating__point.html#a5">qsqrt</a> (<span class="keywordtype">float</span> x)
00072 {
00073   <span class="keywordtype">float</span> ret;
00074   <span class="keyword">static</span> <span class="keywordtype">float</span> c1=0.5f;
00075   <span class="keyword">static</span> <span class="keywordtype">float</span> c2=1.5f;
00076 
00077 
00078 <span class="comment">// Original C++ formulae:</span>
00079 <span class="comment">// float tmp = x;</span>
00080 <span class="comment">// *((unsigned *)&amp;tmp) = (0xbe6f0000 - *((unsigned *)&amp;tmp)) &gt;&gt; 1;</span>
00081 <span class="comment">// double h = x * 0.5;</span>
00082 <span class="comment">// double a = tmp;</span>
00083 <span class="comment">// a *= 1.5 - a * a * h;</span>
00084 <span class="comment">// a *= 1.5 - a * a * h;</span>
00085 <span class="comment">// return a * x;</span>
00086 
00087   <span class="comment">// Use __volatile__ so that the compiler will not mess with this</span>
00088   <span class="comment">// code. Under some versions of gcc in combination with -O2 optimize</span>
00089   <span class="comment">// mode not using __volatile__ can cause errors.</span>
00090   __asm__ __volatile__ (
00091                 <span class="stringliteral">"flds   %1\n"</span>                   <span class="comment">// x</span>
00092                 <span class="stringliteral">"movl   $0xbe6f0000,%%eax\n"</span>
00093                 <span class="stringliteral">"subl   %1,%%eax\n"</span>
00094                 <span class="stringliteral">"shrl   $1,%%eax\n"</span>
00095                 <span class="stringliteral">"movl   %%eax,%1\n"</span>
00096                 <span class="stringliteral">"flds   %2\n"</span>                   <span class="comment">// x 0.5</span>
00097                 <span class="stringliteral">"fmul   %%st(1)\n"</span>              <span class="comment">// x h</span>
00098                 <span class="stringliteral">"flds   %3\n"</span>                   <span class="comment">// x h 1.5</span>
00099                 <span class="stringliteral">"flds   %1\n"</span>                   <span class="comment">// x h 1.5 a</span>
00100                 <span class="stringliteral">"fld    %%st\n"</span>                 <span class="comment">// x h 1.5 a a</span>
00101                 <span class="stringliteral">"fmul   %%st\n"</span>                 <span class="comment">// x h 1.5 a a*a</span>
00102                 <span class="stringliteral">"fmul   %%st(3)\n"</span>              <span class="comment">// x h 1.5 a a*a*h</span>
00103                 <span class="stringliteral">"fsubr  %%st(2)\n"</span>              <span class="comment">// x h 1.5 a 1.5-a*a*h</span>
00104                 <span class="stringliteral">"fmulp  %%st(1)\n"</span>              <span class="comment">// x h 1.5 a</span>
00105                 <span class="stringliteral">"fld    %%st\n"</span>                 <span class="comment">// x h 1.5 a a</span>
00106                 <span class="stringliteral">"fmul   %%st\n"</span>                 <span class="comment">// x h 1.5 a a*a</span>
00107                 <span class="stringliteral">"fmulp  %%st(3)\n"</span>              <span class="comment">// x a*a*h 1.5 a</span>
00108                 <span class="stringliteral">"fxch\n"</span>                        <span class="comment">// x a*a*h a 1.5</span>
00109                 <span class="stringliteral">"fsubp  %%st,%%st(2)\n"</span>         <span class="comment">// x 1.5-a*a*h a</span>
00110                 <span class="stringliteral">"fmulp  %%st(1)\n"</span>              <span class="comment">// x a</span>
00111                 <span class="stringliteral">"fmulp  %%st(1)\n"</span>              <span class="comment">// a</span>
00112         : <span class="stringliteral">"=&amp;t"</span> (ret), <span class="stringliteral">"+m"</span> (x) : <span class="stringliteral">"m"</span> (c1), <span class="stringliteral">"m"</span> (c2)
00113         : <span class="stringliteral">"eax"</span>, <span class="stringliteral">"st(1)"</span>, <span class="stringliteral">"st(2)"</span>, <span class="stringliteral">"st(3)"</span>, <span class="stringliteral">"st(4)"</span>, <span class="stringliteral">"st(5)"</span>, <span class="stringliteral">"st(6)"</span>, <span class="stringliteral">"st(7)"</span>
00114   );
00115   <span class="keywordflow">return</span> ret;
00116 }
00117 
00125 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__floating__point.html#a6">qisqrt</a> (<span class="keywordtype">float</span> x)
00126 {
00127   <span class="keywordtype">float</span> ret;
00128   <span class="keyword">static</span> <span class="keywordtype">float</span> c1=0.5f;
00129   <span class="keyword">static</span> <span class="keywordtype">float</span> c2=1.5f;
00130   <span class="comment">// Use __volatile__ so that the compiler will not mess with this</span>
00131   <span class="comment">// code. Under some versions of gcc in combination with -O2 optimize</span>
00132   <span class="comment">// mode not using __volatile__ can cause errors.</span>
00133   __asm__ __volatile__ (
00134                 <span class="stringliteral">"flds   %1\n"</span>                   <span class="comment">// x</span>
00135                 <span class="stringliteral">"movl   $0xbe6f0000,%%eax\n"</span>
00136                 <span class="stringliteral">"subl   %1,%%eax\n"</span>
00137                 <span class="stringliteral">"shrl   $1,%%eax\n"</span>
00138                 <span class="stringliteral">"movl   %%eax,%1\n"</span>
00139                 <span class="stringliteral">"flds   %2\n"</span>                   <span class="comment">// x 0.5</span>
00140                 <span class="stringliteral">"fmulp  %%st(1)\n"</span>              <span class="comment">// h</span>
00141                 <span class="stringliteral">"flds   %3\n"</span>                   <span class="comment">// h 1.5</span>
00142                 <span class="stringliteral">"flds   %1\n"</span>                   <span class="comment">// h 1.5 a</span>
00143                 <span class="stringliteral">"fld    %%st\n"</span>                 <span class="comment">// h 1.5 a a</span>
00144                 <span class="stringliteral">"fmul   %%st\n"</span>                 <span class="comment">// h 1.5 a a*a</span>
00145                 <span class="stringliteral">"fmul   %%st(3)\n"</span>              <span class="comment">// h 1.5 a a*a*h</span>
00146                 <span class="stringliteral">"fsubr  %%st(2)\n"</span>              <span class="comment">// h 1.5 a 1.5-a*a*h</span>
00147                 <span class="stringliteral">"fmulp  %%st(1)\n"</span>              <span class="comment">// h 1.5 a</span>
00148                 <span class="stringliteral">"fld    %%st\n"</span>                 <span class="comment">// h 1.5 a a</span>
00149                 <span class="stringliteral">"fmul   %%st\n"</span>                 <span class="comment">// h 1.5 a a*a</span>
00150                 <span class="stringliteral">"fmulp  %%st(3)\n"</span>              <span class="comment">// a*a*h 1.5 a</span>
00151                 <span class="stringliteral">"fxch\n"</span>                        <span class="comment">// a*a*h a 1.5</span>
00152                 <span class="stringliteral">"fsubp  %%st,%%st(2)\n"</span>         <span class="comment">// 1.5-a*a*h a</span>
00153                 <span class="stringliteral">"fmulp  %%st(1)\n"</span>              <span class="comment">// a</span>
00154         : <span class="stringliteral">"=t"</span> (ret), <span class="stringliteral">"+m"</span> (x) : <span class="stringliteral">"m"</span> (c1), <span class="stringliteral">"m"</span> (c2)
00155         : <span class="stringliteral">"eax"</span>, <span class="stringliteral">"st(1)"</span>, <span class="stringliteral">"st(2)"</span>, <span class="stringliteral">"st(3)"</span>, <span class="stringliteral">"st(4)"</span>, <span class="stringliteral">"st(5)"</span>, <span class="stringliteral">"st(6)"</span>, <span class="stringliteral">"st(7)"</span>
00156   );
00157   <span class="keywordflow">return</span> ret;
00158 }
00159 
00160 <span class="preprocessor">#elif (!defined (CS_NO_QSQRT)) &amp;&amp; defined (PROC_POWERPC) &amp;&amp; defined (COMP_GCC)</span>
00161 <span class="preprocessor"></span>
00169 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__floating__point.html#a5">qsqrt</a>(<span class="keywordtype">float</span> x)
00170 {
00171   <span class="keywordtype">float</span> y0 = 0.0;
00172 
00173   <span class="keywordflow">if</span> (x != 0.0)
00174   {
00175     <span class="keywordtype">float</span> x0 = x * 0.5f;
00176 
00177     __asm__ __volatile__ (<span class="stringliteral">"frsqrte %0,%1"</span> : <span class="stringliteral">"=f"</span> (y0) : <span class="stringliteral">"f"</span> (x));
00178     
00179     y0 = y0 * (1.5f - x0 * y0 * y0);
00180     y0 = (y0 * (1.5f - x0 * y0 * y0)) * x;
00181   };
00182     
00183   <span class="keywordflow">return</span> y0;
00184 };
00185 
00190 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__floating__point.html#a6">qisqrt</a>(<span class="keywordtype">float</span> x)
00191 {
00192   <span class="keywordtype">float</span> x0 = x * 0.5f;
00193   <span class="keywordtype">float</span> y0;
00194   __asm__ __volatile__ (<span class="stringliteral">"frsqrte %0,%1"</span> : <span class="stringliteral">"=f"</span> (y0) : <span class="stringliteral">"f"</span> (x));
00195     
00196   y0 = y0 * (1.5f - x0 * y0 * y0);
00197   y0 = y0 * (1.5f - x0 * y0 * y0);
00198 
00199   <span class="keywordflow">return</span> y0;
00200 };
00201 
00202 <span class="preprocessor">#elif (!defined (CS_NO_QSQRT)) &amp;&amp; defined (PROC_X86) &amp;&amp; defined (COMP_VC)</span>
00203 <span class="preprocessor"></span>
00204 <span class="preprocessor">#include &lt;math.h&gt;</span>
00205 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__floating__point.html#a5">qsqrt</a> (<span class="keywordtype">float</span> x) { <span class="keywordflow">return</span> sqrtf(x); }
00206 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__floating__point.html#a6">qisqrt</a>(<span class="keywordtype">float</span> x) { <span class="keywordflow">return</span> 1.0f / sqrtf(x); }
00207 
00208 <span class="preprocessor">#else</span>
00209 <span class="preprocessor"></span>
00210 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00211"></a><a class="code" href="group__floating__point.html#a5">00211</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__floating__point.html#a5">qsqrt</a> (<span class="keywordtype">float</span> x) { <span class="keywordflow">return</span> (float)sqrt(x); }
<a name="l00212"></a><a class="code" href="group__floating__point.html#a6">00212</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> <a class="code" href="group__floating__point.html#a6">qisqrt</a>(<span class="keywordtype">float</span> x) { <span class="keywordflow">return</span> (float)(1.0 / sqrt(x)); }
00213 
00214 <span class="preprocessor">#endif</span>
00215 <span class="preprocessor"></span>
00216 <span class="preprocessor">#endif // __CS_QSQRT_H__</span>
</pre></div><hr><address><small>Generated for Crystal Space by 
<a href="http://www.doxygen.org/index.html">doxygen</a> 1.2.18 
</small></address> </div></body> </html>
