#!/usr/bin/make -f
# Sample debian/rules that uses debhelper. 
# GNU copyright 1997 by Joey Hess.
#
# This version is for a hypothetical package that builds an
# architecture-dependant package, as well as an architecture-independent
# package.

# Uncomment this to turn on verbose mode. 
#export DH_VERBOSE=1

# This is the debhelper compatability version to use.
export DH_COMPAT=4
# This has to be exported to make some magic below work.
export DH_OPTIONS

CFLAGS = -Wall -g

ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
	CFLAGS += -O0
else
	CFLAGS += -O2
endif
ifeq (,$(findstring nostrip,$(DEB_BUILD_OPTIONS)))
	INSTALL_PROGRAM += -s
endif

configure: configure-stamp
configure-stamp:
	dh_testdir
	# Add here commands to configure the package.
	# Activate all plugins
	# @@@ FIXME: This does not handle plugins protected by ifeq/ifneq.
#	perl -pi -e "s/^#PLUGINS/PLUGINS/" $(CURDIR)/CS/mk/user.mak
	# Temp remove of render3d renderers
	#perl -pi -e "s/^PLUGINS(.*render3.*$)/#PLUGINS\1/" $(CURDIR)/CS/mk/user.mak
	# Temp? remove of cslua
#	perl -pi -e "s/^PLUGINS(.*cslua.*$)/#PLUGINS\1/" $(CURDIR)/CS/mk/user.mak
	# Temp? remove of openal
	#perl -pi -e "s/^PLUGINS(.*openal.*$)/#PLUGINS\1/" $(CURDIR)/CS/mk/user.mak
	# --disable-qsqrt was added for a gcc3.2 bug
	cd CS; cs_cv_cxx_qsqrt_ok=no ./configure --prefix=/usr --disable-cpu-specific-instructions 
	# --disable-qsqrt
	# Force -fPIC as compiling/linking option
	echo "CFLAGS.SYSTEM += -fPIC"  >> $(CURDIR)/CS/config.mak 
	echo "LFLAGS.EXE += -fPIC"  >> $(CURDIR)/CS/config.mak 
	echo "LFLAGS.DLL += -fPIC"  >> $(CURDIR)/CS/config.mak 

	# Install as much as possible
#	perl -pi -e "s/#TO_INSTALL/TO_INSTALL/" $(CURDIR)/CS/cache.mak
	# Activating scripts
	chmod +x $(CURDIR)/debian/createmenus
	chmod +x $(CURDIR)/debian/addmissing
	chmod +x $(CURDIR)/debian/automan
	# Creating menus
	$(CURDIR)/debian/createmenus $(CURDIR)

	touch configure-stamp

#Architecture
build: build-arch build-indep

build-arch: build-arch-stamp
build-arch-stamp: configure-stamp

	# Add here commands to compile the package.
	cd CS; $(MAKE) all
	# should be something like this $(MAKE) all USE_SHARED_LIBS=yes
	# if compile fails with gcc3.2 edit CS/include/volatile.h with #define CS_NO_QSQRT

build-indep: build-indep-stamp
build-indep-stamp: configure-stamp

	# Add here commands to compile the indep part of the package.
	#$(MAKE) doc

clean:
	dh_testdir
	dh_testroot
	rm -f build-arch-stamp build-indep-stamp configure-stamp

	# Add here commands to clean up after the build process.
	-cd $(CURDIR)/CS; $(MAKE) distclean

	dh_clean

DEVBIN=map2cs mdl2spr scfreg vsh cs-config 3ds2lev cs2xml csfgen cslight maya2spr md32spr milk2spr python.cex tbconvert

install: install-indep install-arch
install-indep:
	
	dh_testdir
	dh_testroot
	dh_clean -k -i
	dh_installdirs -i

	# Add here commands to install the indep part of the package into
	# debian/<package>-doc.
	#INSTALLDOC#
	mkdir $(CURDIR)/debian/tmp
	cd CS; $(MAKE) SUBMAKEFILES=mk/install.mak INSTALL_DIR=$(CURDIR)/debian/tmp/usr/lib/crystalspace install 

	dh_movefiles -i

install-arch:
	dh_testdir
	dh_testroot
	dh_clean -k -a
	dh_installdirs -a

	# Add here commands to install the package into debian/crystalspace.
	mkdir -p $(CURDIR)/debian/tmp/usr/lib/crystalspace
	cd CS; $(MAKE) install INSTALL_DIR=$(CURDIR)/debian/tmp/usr/lib/crystalspace
	# Let's fix some things
#	$(CURDIR)/debian/addmissing $(CURDIR)

	find $(CURDIR)/debian/tmp/usr/lib/crystalspace/include -type f \
		-exec chmod 644 {} \;
	chmod +x \
	$(CURDIR)/debian/tmp/usr/lib/crystalspace/scripts/python/cssh.py
	chmod +x \
	$(CURDIR)/debian/tmp/usr/lib/crystalspace/scripts/python/pysimp.py
	
	# Move to respect Debian Policy

	# dev binaries in /usr/bin
	mkdir -p $(CURDIR)/debian/tmp/usr/bin
	mv $(addprefix $(CURDIR)/debian/tmp/usr/lib/crystalspace/bin/,\
		 $(DEVBIN))\
		$(CURDIR)/debian/tmp/usr/bin
	# renaming picview because of name conflict with picview package
	#mv $(CURDIR)/debian/tmp/usr/bin/picview \
	#	$(CURDIR)/debian/tmp/usr/bin/cspicview
	# From Loic Dachary (fix for cs-config)
	perl -pi -e 's:^prefix=.*:prefix=/usr:' $(CURDIR)/debian/tmp/usr/bin/cs-config
	perl -pi -e 's:^includedir=.*:includedir=/usr/include/crystalspace:' $(CURDIR)/debian/tmp/usr/bin/cs-config
	perl -pi -e 's:libdir=.*:libdir=/usr/lib/crystalspace/lib:' $(CURDIR)/debian/tmp/usr/bin/cs-config

	# demos binaries in /usr/games
	mkdir -p $(CURDIR)/debian/tmp/usr/games
	mv $(CURDIR)/debian/tmp/usr/lib/crystalspace/bin/* \
		$(CURDIR)/debian/tmp/usr/games

	# renaming zoo because of name conflict with /usr/bin/zoo
#	mv $(CURDIR)/debian/tmp/usr/games/zoo \
#		$(CURDIR)/debian/tmp/usr/games/cszoo

	# includes in /usr/include/crystalspace
	mkdir -p $(CURDIR)/debian/tmp/usr/include
	mv $(CURDIR)/debian/tmp/usr/lib/crystalspace/include \
		$(CURDIR)/debian/tmp/usr/include/crystalspace

	# config files in /etc/crystalspace
	mkdir -p $(CURDIR)/debian/tmp/etc/crystalspace
	mv $(CURDIR)/debian/tmp/usr/lib/crystalspace/data/config \
		$(CURDIR)/debian/tmp/etc/crystalspace
	mv $(CURDIR)/debian/tmp/usr/lib/crystalspace/*.cfg \
		$(CURDIR)/debian/tmp/etc/crystalspace

	dh_movefiles -a

	# Adding home made xpm
	cp $(CURDIR)/xpm/*.xpm \
		$(CURDIR)/debian/crystalspace-demos/usr/share/pixmaps

	# Autogenerate man
	$(CURDIR)/debian/automan $(CURDIR)
	$(CURDIR)/debian/rules man
	rm -f $(CURDIR)/debian/man/*.sgml.?
	dh_installman -p crystalspace-demos $(CURDIR)/debian/man/*.6
	dh_installman -p crystalspace-dev $(CURDIR)/debian/man/*.1

%.xpm: %.jpg
	convert -size 32x32 $< $@
	mogrify -format xpm -geometry 32x32 -map /usr/X11R6/include/X11/pixmaps/cmap.xpm $@

man: $(subst .sgml,, $(wildcard $(CURDIR)/debian/man/*.sgml*))
%.1: %.sgml.1
	@echo "Creating $(notdir $@)"
	@docbook-to-man $< > $@
%.6: %.sgml.6
	@echo "Creating $(notdir $@)"
	@docbook-to-man $< > $@

# Must not depend on anything. This is to be called by
# binary-arch/binary-multi
# in another 'make' thread.
binary-common:
	dh_testdir
	dh_testroot
#	dh_installdebconf	
	dh_installdocs
	dh_installexamples
	dh_installmenu
#	dh_installemacsen
#	dh_installpam
#	dh_installinit
	dh_installcron
#	dh_installmanpages
	dh_installinfo
#	dh_undocumented
	dh_installchangelogs 
	dh_link
	dh_strip
	dh_compress 
	dh_fixperms
	# You may want to make some executables suid here.
	dh_suidregister
	dh_makeshlibs
	dh_installdeb
#	dh_perl
	dh_shlibdeps -l$(CURDIR)/debian/usr/lib/crystalspace/lib
	dh_gencontrol
	dh_md5sums
	dh_builddeb
# Build architecture independant packages using the common target.
binary-indep: build-indep install-indep
	$(MAKE) -f debian/rules DH_OPTIONS=-i binary-common

# Build architecture dependant packages using the common target.
binary-arch: build-arch install-arch
	$(MAKE) -f debian/rules DH_OPTIONS=-a binary-common

binary: binary-arch binary-indep
.PHONY: build clean binary-indep binary-arch binary install install-indep install-arch configure
