SubDir TOP plugins aws ;

FILES = [ Wildcard *.cpp *.h *.hpp ] ;

if ! [ Property build : projgen ]
{
  if $(CMD.BISON) && $(CMD.FLEX)
  {
    FILES = [ Filter $(FILES) : skinlex.cpp skinpars.cpp skinparse.hpp ] 
	skinlex.ll skinpars.yy ;
    BisonFlags skinpars.yy : "-p aws" ;

    # skinlex.cpp includes the generated skinpars.hpp, so we must ensure that
    # skinpars.hpp is generated before skinlex.cpp, since we do not want
    # skinlex.cpp accidentally including the factory-supplied skinpars.hpp from
    # the source directory.
    local lex = [ DoObjectGrist skinlex.cpp ] ;
    local parse = [ DoObjectGrist skinpars.cpp ] ;
    Depends $(lex) : $(parse) ;

    # Construct a rule for copying the generated sources from Bison and Flex
    # into the source directories.
    FREEZEFILES = skinpars.cpp skinpars.hpp skinlex.cpp ;
    FREEZEFILES = $(FREEZEFILES:G=awsfreeze) ;
    for i in $(FREEZEFILES)
    {
      SEARCH on $(i) = $(LOCATE_TARGET) ;
      local targetfile = $(i:D=$(SUBDIR)) ;
      
      Copy $(targetfile) : $(i) ;
      Depends $(targetfile) : $(i) ;
      Depends awsfreeze : $(targetfile) ;
    }

    NotFile awsfreeze ;
    Help awsfreeze : "Copy generated Bison/Flex files to source directory" :
      verbatim ;
  }
}

Help aws : "Alternate Windowing System plug-in" ;
Plugin aws : $(FILES) ;
LinkWith aws : cstool csgfx csgeom csutil ;

if "$(COMPILER.C++FLAGS.WARNING.NO_UNUSED)"
{
  # We can't avoid unused variables in auto-generated code, so disable warning.
  C++FLAGS on [ DoObjectGrist skinlex$(SUFOBJ) skinpars$(SUFOBJ) ] +=
    $(COMPILER.C++FLAGS.WARNING.NO_UNUSED) ;
}

# If Bison and Flex are installed, then skinpars.cpp and skinlex.cpp reside in
# $(LOCATE_TARGET) rather than CS/plugins/aws, so we need to tell those files
# that some headers they require reside in CS/plugins/aws.  Also, we ensure
# that skinlex.cpp searches $(LOCATE_TARGET) first because it needs to locate
# the generated skinpars.hpp rather than the factory-supplied one in
# CS/plugins/aws.  (In reality, LOCATE_TARGET should be searched automatically
# since #include "skinpars.hpp" is used, and LOCATE_TARGET is the "current
# directory" in this case, but we do this for that extra measure of insurance.)
C++FLAGS on [ DoObjectGrist skinpars$(SUFOBJ) skinlex$(SUFOBJ) ] +=
  [ FIncludes $(LOCATE_TARGET) $(SEARCH_SOURCE) ] ;

if [ Property build : projgen ] = msvc
{
  MsvcCFlags aws : "/D \"YY_NEVER_INTERACTIVE\"" ;
}
