SubDir TOP plugins cscript csperl5 ;

if $(PERL5.AVAILABLE) = "yes"
{
  Help csperl5 : "Crystal Script Perl5 plug-in" ;
  
  if $(PERL5.EXTUTILS.EMBED.AVAILABLE) = "yes"
  {
    if $(PERL5.DYNALOADER.AVAILABLE) = "yes"
    {
      actions PerlEmbedGlueFile
      {
        $(CMD.PERL5) -MExtUtils::Embed -e xsinit -- \
        -o $(<) -std DynaLoader cspace
      }
    }
    else
    {
      actions PerlEmbedGlueFile
      {
        $(CMD.PERL5) -MExtUtils::Embed -e xsinit -- \
        -o $(<) -std cspace
      }
    }
  }
  else
  {
    actions PerlEmbedGlueFile
    {
      echo '#include "csutil/csperlxs_fallback.inc"' > $(<)
    }
  }

  if $(CMD.SWIG)
  {
    # for details and comments look at the cspython Jamfile
    local target = cswigpl5.inc ;
    local sources = [ FGristFiles cspace.i ] ;

    SEARCH on $(sources) = $(TOP)/include/ivaria ;
    HDRGRIST on $(sources) = $(HDRGRIST) ;
    HDRSEARCH on $(sources) = 
      $(SEARCH_SOURCE:E) $(SUBDIRHDRS) $(HDRS) $(STDHDRS) ;
    HDRRULE on $(sources) = HeaderRule ;
    HDRSCAN on $(sources) = $(SWIG.HDRPATTERN) ;
    SWIG.FLAGS on $(target) += -perl5 -c++ -v -shadow -const -I$(TOP)/include 
			       -module cspace ;
		    
    Swig $(target) : $(sources) ;
  }

  local perlxs = [ FGristFiles csperlxs.c ] ;
  PerlEmbedGlueFile $(perlxs) ;
  LOCATE on $(perlxs) = $(LOCATE_TARGET) ;
  SEARCH on $(perlxs) = $(LOCATE_TARGET) ;
  
  FILES = csperl5.cpp csperl5.h cswigpl5.cpp csperlxs.c ;
  
  Plugin csperl5
	  : $(FILES)
  ;
  CFlags csperl5 : -I$(TOP)/scripts/perl5 -Wno-unused ;
  LinkWith csperl5 : cstool csgeom csutil ;
  ExternalLibs csperl5 : PERL5 ;
  Clean clean : $(perlxs) ;
  Clean csperl5clean : $(perlxs) ;
}
